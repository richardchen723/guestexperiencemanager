{% extends "base.html" %}

{% block title %}Properties - Hostaway Insights Dashboard{% endblock %}

{% block content %}
<div class="properties-page">
    <div class="page-header">
        <div>
            <h1 class="page-title">Properties</h1>
            <p class="page-description">Manage and analyze your property portfolio</p>
        </div>
    </div>
    
    <div class="search-section">
        <div class="search-box">
            <svg class="search-icon" width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M9 17C13.4183 17 17 13.4183 17 9C17 4.58172 13.4183 1 9 1C4.58172 1 1 4.58172 1 9C1 13.4183 4.58172 17 9 17Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M19 19L14.65 14.65" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            <input type="text" id="searchInput" class="form-input search-input" placeholder="Search by property name or address..." onkeyup="filterListings()">
        </div>
        <div id="tagFilterContainer" class="tag-filter"></div>
    </div>
    
    <div id="loading" class="loading" style="display: none;">
        <div class="spinner"></div>
        <span>Loading properties...</span>
    </div>
    
    <div id="listingsContainer" class="listings-grid grid grid-auto-fit">
        <!-- Listings will be loaded here -->
    </div>
    
    <div id="noResults" class="empty-state" style="display: none;">
        <div class="empty-state-icon">üè†</div>
        <h3 class="empty-state-title">No properties found</h3>
        <p class="empty-state-description">No properties match your search criteria. Try adjusting your search terms.</p>
    </div>
</div>

<script src="/static/js/tags.js"></script>
<script>
let tagFilter = null;
let selectedTagIds = [];
let tagLogic = 'AND';

// Load listings on page load
document.addEventListener('DOMContentLoaded', function() {
    // Initialize tag filter (with error handling)
    try {
        tagFilter = new TagFilter('#tagFilterContainer', {
            onFilterChange: (tagIds, logic) => {
                selectedTagIds = tagIds;
                tagLogic = logic;
                loadListings();
            }
        });
    } catch (error) {
        console.error('Error initializing tag filter:', error);
        // Continue without tag filter - page should still work
        tagFilter = null;
    }
    
    loadListings();
});

function loadListings() {
    const container = document.getElementById('listingsContainer');
    const loading = document.getElementById('loading');
    const noResults = document.getElementById('noResults');
    
    loading.style.display = 'block';
    container.innerHTML = '';
    
    // Build query params
    const params = new URLSearchParams();
    if (selectedTagIds.length > 0 && tagFilter && tagFilter.allTags) {
        // Get tag names from selected IDs
        const selectedTags = tagFilter.allTags.filter(t => selectedTagIds.includes(t.tag_id));
        if (selectedTags.length > 0) {
            params.append('tags', selectedTags.map(t => t.name).join(','));
            params.append('tag_logic', tagLogic);
        }
    }
    
    fetch(`/api/listings?${params.toString()}`)
        .then(response => response.json())
        .then(listings => {
            loading.style.display = 'none';
            
            if (listings.length === 0) {
                noResults.style.display = 'block';
                return;
            }
            
            listings.forEach(listing => {
                const card = document.createElement('div');
                card.className = 'listing-card';
                // Use internal_name for display, fallback to name
                const displayName = listing.internal_name || listing.name;
                card.setAttribute('data-name', displayName.toLowerCase());
                card.setAttribute('data-address', (listing.address || '').toLowerCase());
                
                // Get quality rating and create badge
                const qualityRating = listing.quality_rating;
                let ratingBadge;
                if (qualityRating && (qualityRating === 'Good' || qualityRating === 'Fair' || qualityRating === 'Poor')) {
                    const ratingClass = qualityRating.toLowerCase();
                    ratingBadge = `<span class="quality-badge quality-badge-${ratingClass}">${qualityRating}</span>`;
                } else {
                    ratingBadge = `<span class="quality-badge quality-badge-not-rated">Not Rated</span>`;
                }
                
                card.innerHTML = `
                    <div class="listing-card-header">
                        <div class="listing-card-title-section">
                            <h3 class="listing-card-title">${escapeHtml(displayName)}</h3>
                            ${ratingBadge}
                        </div>
                    </div>
                    <div class="listing-card-body">
                        <div class="listing-card-location">
                            <svg class="location-icon" width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M8 8.5C9.10457 8.5 10 7.60457 10 6.5C10 5.39543 9.10457 4.5 8 4.5C6.89543 4.5 6 5.39543 6 6.5C6 7.60457 6.89543 8.5 8 8.5Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M8 1C6.34315 1 5 2.34315 5 4C5 5.65685 8 11 8 11C8 11 11 5.65685 11 4C11 2.34315 9.65685 1 8 1Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            <div>
                                <p class="listing-card-address">${escapeHtml(listing.address || 'No address')}</p>
                                ${listing.city ? `<p class="listing-card-city">${escapeHtml(listing.city)}</p>` : ''}
                            </div>
                        </div>
                        <div class="listing-card-tags-section">
                            <div class="listing-card-tags-header">
                                <label>Tags</label>
                                <button class="btn btn-link btn-sm" onclick="toggleTagEdit(${listing.listing_id})" style="padding: 0.25rem 0.5rem; font-size: 0.75rem; color: #2563eb;">
                                    <span id="tagEditBtn-${listing.listing_id}">+ Add</span>
                                </button>
                            </div>
                            <div id="tagsDisplay-${listing.listing_id}" class="tags-display"></div>
                            <div id="tagsInput-${listing.listing_id}" class="tag-input-container" style="display: none; margin-top: 0.5rem;"></div>
                        </div>
                    </div>
                    <div class="listing-card-footer">
                        <a href="/insights/${listing.listing_id}" class="btn btn-primary btn-block">View Details</a>
                    </div>
                `;
                
                container.appendChild(card);
                
                // Initialize tags display and input for this listing
                initializeListingTags(listing.listing_id, listing.tags || []);
            });
        })
        .catch(error => {
            loading.style.display = 'none';
            container.innerHTML = `<div class="error">Error loading listings: ${error.message}</div>`;
        });
}

function filterListings() {
    const input = document.getElementById('searchInput');
    const filter = input.value.toLowerCase();
    const cards = document.querySelectorAll('.listing-card');
    const noResults = document.getElementById('noResults');
    
    let visibleCount = 0;
    
    cards.forEach(card => {
        const name = card.getAttribute('data-name');
        const address = card.getAttribute('data-address');
        const matches = name.includes(filter) || address.includes(filter);
        
        card.style.display = matches ? 'block' : 'none';
        if (matches) visibleCount++;
    });
    
    noResults.style.display = visibleCount === 0 && filter ? 'block' : 'none';
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Tag management for listings
const listingTagInputs = {};

function initializeListingTags(listingId, tags) {
    // Store tags for this listing
    if (!window.listingTagsMap) {
        window.listingTagsMap = {};
    }
    window.listingTagsMap[listingId] = tags;
    
    // Display current tags
    const displayContainer = document.getElementById(`tagsDisplay-${listingId}`);
    if (displayContainer) {
        renderTags(displayContainer, tags, {
            onRemove: (tag, index) => {
                removeListingTag(listingId, tag.tag_id);
            }
        });
    }
    
    // Initialize tag input (hidden by default)
    const inputContainer = document.getElementById(`tagsInput-${listingId}`);
    if (inputContainer && !listingTagInputs[listingId]) {
        listingTagInputs[listingId] = new TagInput(inputContainer, {
            existingTags: tags,
            onTagsChange: (newTags) => {
                // Get tags that were added
                const currentTags = window.listingTagsMap[listingId] || [];
                const currentTagIds = currentTags.map(t => t.tag_id);
                const tagsToAdd = newTags.filter(t => !currentTagIds.includes(t.tag_id));
                if (tagsToAdd.length > 0) {
                    addListingTags(listingId, tagsToAdd.map(t => t.name));
                }
            }
        });
    }
}

function toggleTagEdit(listingId) {
    const inputContainer = document.getElementById(`tagsInput-${listingId}`);
    const displayContainer = document.getElementById(`tagsDisplay-${listingId}`);
    const editBtn = document.getElementById(`tagEditBtn-${listingId}`);
    
    if (inputContainer && displayContainer) {
        const isEditing = inputContainer.style.display !== 'none';
        inputContainer.style.display = isEditing ? 'none' : 'block';
        displayContainer.style.display = isEditing ? 'flex' : 'none';
        if (editBtn) {
            editBtn.textContent = isEditing ? '+ Add' : 'Done';
        }
        
        // Focus input when showing
        if (!isEditing && listingTagInputs[listingId] && listingTagInputs[listingId].input) {
            setTimeout(() => {
                listingTagInputs[listingId].input.focus();
            }, 100);
        }
    }
}

async function addListingTags(listingId, tagNames) {
    try {
        const response = await fetch(`/api/listings/${listingId}/tags`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ tags: tagNames })
        });
        
        if (response.ok) {
            const addedTags = await response.json();
            // Reload tags for this listing
            loadListingTags(listingId);
        } else {
            const error = await response.json();
            alert(error.error || 'Failed to add tags');
        }
    } catch (error) {
        console.error('Error adding tags:', error);
        alert('Failed to add tags');
    }
}

async function removeListingTag(listingId, tagId) {
    try {
        const response = await fetch(`/api/listings/${listingId}/tags/${tagId}`, {
            method: 'DELETE'
        });
        
        if (response.ok) {
            // Reload tags for this listing
            loadListingTags(listingId);
        } else {
            const error = await response.json();
            alert(error.error || 'Failed to remove tag');
        }
    } catch (error) {
        console.error('Error removing tag:', error);
        alert('Failed to remove tag');
    }
}

async function loadListingTags(listingId) {
    try {
        const response = await fetch(`/api/listings/${listingId}/tags`);
        if (response.ok) {
            const tags = await response.json();
            
            // Update stored tags
            if (!window.listingTagsMap) {
                window.listingTagsMap = {};
            }
            window.listingTagsMap[listingId] = tags;
            
            const displayContainer = document.getElementById(`tagsDisplay-${listingId}`);
            if (displayContainer) {
                renderTags(displayContainer, tags, {
                    onRemove: (tag, index) => {
                        removeListingTag(listingId, tag.tag_id);
                    }
                });
            }
            
            // Update tag input if it exists
            if (listingTagInputs[listingId]) {
                listingTagInputs[listingId].setTags(tags);
            }
        }
    } catch (error) {
        console.error('Error loading listing tags:', error);
    }
}
</script>
{% endblock %}

