{% extends "base.html" %}

{% block title %}Tickets - Hostaway Insights Dashboard{% endblock %}

{% block content %}
<div class="tickets-page">
    <div class="tickets-header">
        <h2>Tickets</h2>
            <a href="/tickets/create" class="btn-primary">Create New Ticket</a>
    </div>
    
    <div class="tickets-search-bar">
        <div class="search-input-wrapper">
            <svg class="search-icon" width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M9 17C13.4183 17 17 13.4183 17 9C17 4.58172 13.4183 1 9 1C4.58172 1 1 4.58172 1 9C1 13.4183 4.58172 17 9 17Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M19 19L14.65 14.65" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            <input type="text" id="searchInput" class="tickets-search-input" placeholder="Search tickets by number, title, or description..." autocomplete="off">
            <button type="button" id="clearSearchBtn" class="clear-search-btn" style="display: none;" onclick="clearSearch()" aria-label="Clear search">
                <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 4L4 12M4 4L12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </button>
        </div>
    </div>
    
    <div class="tickets-filters">
        <div class="filter-group">
            <label for="filterListing">Listing:</label>
            <select id="filterListing">
                <option value="">All Listings</option>
                <option value="0">General (No Property)</option>
            </select>
        </div>
        
        <div class="filter-group">
            <label for="filterAssigned">Assigned To:</label>
            <select id="filterAssigned">
                <option value="">All Users</option>
            </select>
        </div>
        
        <div class="filter-group filter-group-status">
            <label for="statusFilterTrigger">Status:</label>
            <div class="status-filter-wrapper">
                <button type="button" id="statusFilterTrigger" class="status-filter-trigger" onclick="toggleStatusFilter()">
                    <span id="statusFilterText">All Statuses</span>
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="status-filter-arrow">
                        <path d="M4 6L8 10L12 6" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </button>
                <div id="statusFilterDropdown" class="status-filter-dropdown" style="display: none;">
                    <div class="status-filter-header">
                        <span class="status-filter-title">Filter by Status</span>
                        <div class="status-filter-actions">
                            <button type="button" onclick="selectAllStatuses()" class="status-filter-action-link">Select All</button>
                            <button type="button" onclick="deselectAllStatuses()" class="status-filter-action-link">Clear</button>
                        </div>
                    </div>
                    <div class="status-filter-options">
                        <label class="status-filter-option">
                            <input type="checkbox" class="status-checkbox" value="Open" checked>
                            <span class="status-checkbox-custom"></span>
                            <span class="status-filter-label">Open</span>
                        </label>
                        <label class="status-filter-option">
                            <input type="checkbox" class="status-checkbox" value="Assigned" checked>
                            <span class="status-checkbox-custom"></span>
                            <span class="status-filter-label">Assigned</span>
                        </label>
                        <label class="status-filter-option">
                            <input type="checkbox" class="status-checkbox" value="In Progress" checked>
                            <span class="status-checkbox-custom"></span>
                            <span class="status-filter-label">In Progress</span>
                        </label>
                        <label class="status-filter-option">
                            <input type="checkbox" class="status-checkbox" value="Blocked" checked>
                            <span class="status-checkbox-custom"></span>
                            <span class="status-filter-label">Blocked</span>
                        </label>
                        <label class="status-filter-option">
                            <input type="checkbox" class="status-checkbox" value="Resolved" checked>
                            <span class="status-checkbox-custom"></span>
                            <span class="status-filter-label">Resolved</span>
                        </label>
                        <label class="status-filter-option">
                            <input type="checkbox" class="status-checkbox" value="Closed" checked>
                            <span class="status-checkbox-custom"></span>
                            <span class="status-filter-label">Closed</span>
                        </label>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="filter-group">
            <label for="filterPriority">Priority:</label>
            <select id="filterPriority">
                <option value="">All Priorities</option>
                <option value="Low">Low</option>
                <option value="Medium">Medium</option>
                <option value="High">High</option>
                <option value="Critical">Critical</option>
            </select>
        </div>
        
        <div class="filter-group">
            <label for="filterCategory">Category:</label>
            <select id="filterCategory">
                <option value="">All Categories</option>
                <option value="cleaning">Cleaning</option>
                <option value="maintenance">Maintenance</option>
                <option value="online">Online</option>
                <option value="technology">Technology</option>
                <option value="review management">Review Management</option>
                <option value="other">Other</option>
            </select>
        </div>
        
        <button onclick="applyFilters()" class="btn-secondary">Apply Filters</button>
        <button onclick="clearFilters()" class="btn-secondary">Clear</button>
    </div>
    
    <div id="tagFilterContainer" class="tag-filter" style="margin-top: 1rem;"></div>
    
    <div id="loading" class="loading" style="display: none;">
        Loading tickets...
    </div>
    
    <div id="ticketsContainer" class="tickets-container">
        <!-- Tickets will be loaded here -->
    </div>
    
    <div id="noTickets" class="no-results" style="display: none;">
        No tickets found.
    </div>
</div>

<script src="/static/js/tags.js"></script>
<script>
let allListings = [];
let allUsers = [];
let tagFilter = null;
let selectedTagIds = [];
let tagLogic = 'AND';
let searchTimeout = null;

// Load data on page load
document.addEventListener('DOMContentLoaded', function() {
    // Initialize tag filter
    tagFilter = new TagFilter('#tagFilterContainer', {
        endpoint: '/api/tags',
        onFilterChange: (tagIds, logic) => {
            selectedTagIds = tagIds;
            tagLogic = logic;
            loadTickets();
        }
    });
    
    loadListings();
    loadUsers();
    loadTickets();
    
    // Add change listeners to status checkboxes
    document.querySelectorAll('.status-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            updateStatusFilterText();
            loadTickets();
        });
    });
    
    // Add search input event listener with debouncing
    const searchInput = document.getElementById('searchInput');
    const clearSearchBtn = document.getElementById('clearSearchBtn');
    if (searchInput) {
        searchInput.addEventListener('input', function() {
            // Show/hide clear button based on input
            if (clearSearchBtn) {
                clearSearchBtn.style.display = this.value.trim() ? 'flex' : 'none';
            }
            
            // Clear existing timeout
            if (searchTimeout) {
                clearTimeout(searchTimeout);
            }
            
            // Set new timeout for debounced search
            searchTimeout = setTimeout(function() {
                loadTickets();
            }, 400); // 400ms debounce delay
        });
        
        // Handle focus
        searchInput.addEventListener('focus', function() {
            this.parentElement.classList.add('focused');
        });
        
        searchInput.addEventListener('blur', function() {
            this.parentElement.classList.remove('focused');
        });
    }
    
    // Close dropdown when clicking outside
    document.addEventListener('click', function(event) {
        const wrapper = document.querySelector('.status-filter-wrapper');
        const dropdown = document.getElementById('statusFilterDropdown');
        const trigger = document.getElementById('statusFilterTrigger');
        
        if (wrapper && dropdown && trigger && 
            !wrapper.contains(event.target) && 
            dropdown.style.display !== 'none') {
            dropdown.style.display = 'none';
            trigger.classList.remove('active');
        }
    });
    
    // Initialize status filter text
    updateStatusFilterText();
});

function toggleStatusFilter() {
    const dropdown = document.getElementById('statusFilterDropdown');
    const trigger = document.getElementById('statusFilterTrigger');
    
    if (dropdown.style.display === 'none') {
        dropdown.style.display = 'block';
        trigger.classList.add('active');
    } else {
        dropdown.style.display = 'none';
        trigger.classList.remove('active');
    }
}

function updateStatusFilterText() {
    const checkboxes = document.querySelectorAll('.status-checkbox:checked');
    const textElement = document.getElementById('statusFilterText');
    
    if (checkboxes.length === 0) {
        textElement.textContent = 'No Statuses';
    } else if (checkboxes.length === 6) {
        textElement.textContent = 'All Statuses';
    } else if (checkboxes.length === 1) {
        textElement.textContent = checkboxes[0].value;
    } else {
        textElement.textContent = `${checkboxes.length} Selected`;
    }
}

function loadListings() {
    const select = document.getElementById('filterListing');
    if (!select) {
        console.error('filterListing select element not found');
        return;
    }
    
    fetch('/api/listings')
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(listings => {
            allListings = listings || [];
            // Clear existing options except "All Listings"
            while (select.options.length > 1) {
                select.remove(1);
            }
            
            // Add listings
            allListings.forEach(listing => {
                const option = document.createElement('option');
                option.value = listing.listing_id;
                const displayName = listing.internal_listing_name || listing.name || `Listing ${listing.listing_id}`;
                option.textContent = displayName;
                select.appendChild(option);
            });
            
            console.log(`Loaded ${allListings.length} listings`);
        })
        .catch(error => {
            console.error('Error loading listings:', error);
            // Show error to user
            const errorMsg = document.createElement('div');
            errorMsg.className = 'error';
            errorMsg.textContent = 'Failed to load listings. Please refresh the page.';
            errorMsg.style.margin = '0.5rem 0';
            select.parentElement.appendChild(errorMsg);
        });
}

function loadUsers() {
    const select = document.getElementById('filterAssigned');
    if (!select) {
        console.error('filterAssigned select element not found');
        return;
    }
    
    fetch('/tickets/api/users')
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(users => {
            allUsers = users || [];
            // Clear existing options except "All Users"
            while (select.options.length > 1) {
                select.remove(1);
            }
            
            // Add users
            allUsers.forEach(user => {
                const option = document.createElement('option');
                option.value = user.user_id;
                option.textContent = user.name || user.email || `User ${user.user_id}`;
                select.appendChild(option);
            });
            
            console.log(`Loaded ${allUsers.length} users`);
        })
        .catch(error => {
            console.error('Error loading users:', error);
            // Show error to user
            const errorMsg = document.createElement('div');
            errorMsg.className = 'error';
            errorMsg.textContent = 'Failed to load users. Please refresh the page.';
            errorMsg.style.margin = '0.5rem 0';
            select.parentElement.appendChild(errorMsg);
        });
}

function loadTickets() {
    const loading = document.getElementById('loading');
    const container = document.getElementById('ticketsContainer');
    const noTickets = document.getElementById('noTickets');
    
    loading.style.display = 'block';
    container.innerHTML = '';
    
    const params = new URLSearchParams();
    const listingId = document.getElementById('filterListing').value;
    const assignedId = document.getElementById('filterAssigned').value;
    const statusCheckboxes = document.querySelectorAll('.status-checkbox:checked');
    const selectedStatuses = Array.from(statusCheckboxes).map(cb => cb.value);
    const priority = document.getElementById('filterPriority').value;
    const category = document.getElementById('filterCategory').value;
    const searchQuery = document.getElementById('searchInput').value.trim();
    
    if (listingId) params.append('listing_id', listingId);
    if (assignedId) params.append('assigned_user_id', assignedId);
    if (selectedStatuses.length > 0) {
        // Send multiple status values as comma-separated string
        params.append('status', selectedStatuses.join(','));
    }
    if (priority) params.append('priority', priority);
    if (category) params.append('category', category);
    if (searchQuery) params.append('search', searchQuery);
    
    // Add tag filters
    if (selectedTagIds.length > 0 && tagFilter) {
        const selectedTags = tagFilter.allTags.filter(t => selectedTagIds.includes(t.tag_id));
        if (selectedTags.length > 0) {
            params.append('tags', selectedTags.map(t => t.name).join(','));
            params.append('tag_logic', tagLogic);
        }
    }
    
    fetch(`/tickets/api/tickets?${params.toString()}`)
        .then(response => response.json())
        .then(tickets => {
            loading.style.display = 'none';
            
            if (tickets.length === 0) {
                noTickets.style.display = 'block';
                return;
            }
            
            noTickets.style.display = 'none';
            
            tickets.forEach(ticket => {
                const card = createTicketCard(ticket);
                container.appendChild(card);
            });
        })
        .catch(error => {
            loading.style.display = 'none';
            container.innerHTML = `<div class="error">Error loading tickets: ${error.message}</div>`;
        });
}

function createTicketCard(ticket) {
    const card = document.createElement('div');
    card.className = 'ticket-card';
    
    // Get listing names - support multiple listings
    let listingName = 'General';
    if (ticket.listings && ticket.listings.length > 0) {
        // Multiple listings - show all
        const listingNames = ticket.listings.map(l => 
            l.internal_listing_name || l.name || `Listing ${l.listing_id}`
        );
        listingName = listingNames.join(', ');
    } else if (ticket.listing_id) {
        // Fallback to single listing (backward compatibility)
        if (ticket.listing) {
            // Use listing info from API response (includes internal_listing_name)
            listingName = ticket.listing.internal_listing_name || ticket.listing.name || `Listing ${ticket.listing_id}`;
        } else {
            // Fallback to allListings lookup
    const listing = allListings.find(l => l.listing_id === ticket.listing_id);
            if (listing) {
                listingName = listing.internal_listing_name || listing.name || `Listing ${ticket.listing_id}`;
            } else {
                listingName = `Listing ${ticket.listing_id}`;
            }
        }
    }
    
    const statusClass = ticket.status.toLowerCase().replace(' ', '-');
    const priorityClass = ticket.priority.toLowerCase();
    const categoryClass = ticket.category ? ticket.category.toLowerCase() : 'other';
    
    const dueDate = ticket.due_date ? new Date(ticket.due_date) : null;
    const isOverdue = dueDate && dueDate < new Date() && ticket.status !== 'Resolved' && ticket.status !== 'Closed';
    
    const categoryDisplay = ticket.category ? ticket.category.charAt(0).toUpperCase() + ticket.category.slice(1) : 'Other';
    
    // Render tags
    let tagsHtml = '';
    if (ticket.tags && ticket.tags.length > 0) {
        tagsHtml = '<div class="ticket-card-tags tags-display" style="margin-top: 0.5rem;">';
        ticket.tags.forEach(tag => {
            const tagStyle = tag.color ? `style="background-color: ${tag.color}; border-color: ${tag.color};" class="tag-chip has-color"` : 'class="tag-chip"';
            const inheritedClass = tag.is_inherited ? ' tag-chip-inherited' : '';
            const title = tag.is_inherited ? ' title="Inherited from property"' : '';
            tagsHtml += `<span ${tagStyle}${inheritedClass}${title}>${escapeHtml(tag.name)}</span>`;
        });
        tagsHtml += '</div>';
    }
    
    // Check if recurring
    const recurringBadge = ticket.is_recurring ? 
        `<span class="status-badge" style="background: #6366f1; color: white; font-size: 10px; padding: 2px 6px;" title="Recurring task">ðŸ”„ Recurring</span>` : '';
    
    card.innerHTML = `
        <div class="ticket-card-header">
                    <h3><a href="/tickets/${ticket.ticket_id}/page">${escapeHtml(ticket.title)}</a></h3>
            <div class="ticket-badges">
                <span class="status-badge status-${statusClass}">${escapeHtml(ticket.status)}</span>
                <span class="priority-badge priority-${priorityClass}">${escapeHtml(ticket.priority)}</span>
                <span class="category-badge category-${categoryClass}">${escapeHtml(categoryDisplay)}</span>
                ${recurringBadge}
            </div>
        </div>
        <div class="ticket-card-body">
            ${ticket.issue_title ? `<p class="ticket-issue">Issue: ${escapeHtml(ticket.issue_title)}</p>` : ''}
            <p class="ticket-listing">Property: ${escapeHtml(listingName)}</p>
            ${ticket.description ? `<p class="ticket-description">${escapeHtml(ticket.description.substring(0, 150))}${ticket.description.length > 150 ? '...' : ''}</p>` : ''}
            ${tagsHtml}
            <div class="ticket-meta">
                ${ticket.assigned_user_name ? `<span class="ticket-assigned">Assigned to: ${escapeHtml(ticket.assigned_user_name)}</span>` : '<span class="ticket-assigned">Unassigned</span>'}
                ${dueDate ? `<span class="ticket-due ${isOverdue ? 'overdue' : ''}">Due: ${formatDate(dueDate)}</span>` : ''}
            </div>
        </div>
        <div class="ticket-card-footer">
            <span class="ticket-created">Created ${formatDate(new Date(ticket.created_at))}</span>
            <a href="/tickets/${ticket.ticket_id}/page" class="btn-secondary">View Details</a>
        </div>
    `;
    
    return card;
}

function applyFilters() {
    loadTickets();
}

function selectAllStatuses() {
    document.querySelectorAll('.status-checkbox').forEach(cb => cb.checked = true);
    updateStatusFilterText();
    loadTickets();
}

function deselectAllStatuses() {
    document.querySelectorAll('.status-checkbox').forEach(cb => cb.checked = false);
    updateStatusFilterText();
    loadTickets();
}

function clearSearch() {
    const searchInput = document.getElementById('searchInput');
    const clearBtn = document.getElementById('clearSearchBtn');
    if (searchInput) {
        searchInput.value = '';
        if (clearBtn) clearBtn.style.display = 'none';
        // Clear any pending search timeout
        if (searchTimeout) {
            clearTimeout(searchTimeout);
            searchTimeout = null;
        }
        loadTickets();
    }
}

function clearFilters() {
    document.getElementById('filterListing').value = '';
    document.getElementById('filterAssigned').value = '';
    // Select all statuses by default
    document.querySelectorAll('.status-checkbox').forEach(cb => cb.checked = true);
    updateStatusFilterText();
    document.getElementById('filterPriority').value = '';
    document.getElementById('filterCategory').value = '';
    clearSearch();
    if (tagFilter) {
        tagFilter.clear();
    }
    selectedTagIds = [];
    tagLogic = 'AND';
    loadTickets();
}

function formatDate(date) {
    if (!date) return '';
    return new Date(date).toLocaleDateString('en-US', { 
        year: 'numeric', 
        month: 'short', 
        day: 'numeric' 
    });
}

function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}
</script>
{% endblock %}
