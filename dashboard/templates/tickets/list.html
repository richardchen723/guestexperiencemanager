{% extends "base.html" %}

{% block title %}Tickets - Hostaway Insights Dashboard{% endblock %}

{% block content %}
<div class="tickets-page">
    <div class="tickets-header">
        <h2>Tickets</h2>
        <div class="tickets-header-actions">
            <div class="view-toggle">
                <button type="button" id="viewToggleBtn" class="view-toggle-btn active" data-view="list" onclick="toggleView('list')" title="List View">
                    <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <rect x="3" y="4" width="14" height="2" rx="1" fill="currentColor"/>
                        <rect x="3" y="9" width="14" height="2" rx="1" fill="currentColor"/>
                        <rect x="3" y="14" width="14" height="2" rx="1" fill="currentColor"/>
                    </svg>
                    <span>List</span>
                </button>
                <button type="button" id="viewToggleBtnSwim" class="view-toggle-btn" data-view="swimlane" onclick="toggleView('swimlane')" title="Swim Lane View">
                    <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <rect x="2" y="2" width="6" height="6" rx="1" stroke="currentColor" stroke-width="1.5" fill="none"/>
                        <rect x="10" y="2" width="6" height="6" rx="1" stroke="currentColor" stroke-width="1.5" fill="none"/>
                        <rect x="2" y="10" width="6" height="6" rx="1" stroke="currentColor" stroke-width="1.5" fill="none"/>
                        <rect x="10" y="10" width="6" height="6" rx="1" stroke="currentColor" stroke-width="1.5" fill="none"/>
                    </svg>
                    <span>Swim Lane</span>
                </button>
            </div>
            <a href="/tickets/create" class="btn-primary">Create New Ticket</a>
        </div>
    </div>
    
    <div class="tickets-search-bar">
        <div class="search-input-wrapper">
            <svg class="search-icon" width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M9 17C13.4183 17 17 13.4183 17 9C17 4.58172 13.4183 1 9 1C4.58172 1 1 4.58172 1 9C1 13.4183 4.58172 17 9 17Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M19 19L14.65 14.65" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            <input type="text" id="searchInput" class="tickets-search-input" placeholder="Search tickets by number, title, or description..." autocomplete="off">
            <button type="button" id="clearSearchBtn" class="clear-search-btn" style="display: none;" onclick="clearSearch()" aria-label="Clear search">
                <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 4L4 12M4 4L12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </button>
        </div>
        </div>
        
    <!-- Active Filters Bar -->
    <div id="activeFiltersBar" class="active-filters-bar" style="display: none;">
        <div class="active-filters-content">
            <div class="active-filters-label">
                <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M2 4H14M2 8H14M2 12H14" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                </svg>
                <span>Active Filters</span>
            </div>
            <div id="activeFiltersChips" class="active-filters-chips"></div>
            <button type="button" onclick="clearAllFilters()" class="clear-all-filters-btn">
                <svg width="14" height="14" viewBox="0 0 14 14" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M10 4L4 10M4 4L10 10" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                </svg>
                Clear All
            </button>
        </div>
    </div>
    
    <!-- Mobile Filter Button -->
    <button type="button" id="mobileFilterBtn" class="mobile-filter-btn mobile-only" style="display: none;">
        <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
            <path d="M3 4.5H17M3 10H17M3 15.5H17" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
        </svg>
        <span>Filters</span>
        <span id="mobileFilterBadge" class="mobile-filter-badge" style="display: none;"></span>
    </button>
    
    <!-- Modern Filter Panel (Desktop) -->
    <div class="tickets-filters-modern desktop-only">
        <div class="filters-header">
            <button type="button" id="filtersToggleBtn" class="filters-toggle-btn active" onclick="toggleFiltersPanel()">
                <svg width="18" height="18" viewBox="0 0 18 18" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M3 4.5H15M3 9H15M3 13.5H15" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                </svg>
                <span>Filters</span>
                <svg id="filtersToggleArrow" width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="toggle-arrow">
                    <path d="M4 6L8 10L12 6" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </button>
        </div>
        
        <div id="filtersPanel" class="filters-panel" style="display: block;">
            <div class="filters-grid">
                <!-- Property Filter -->
                <div class="filter-card">
                    <div class="filter-card-header">
                        <div class="filter-card-title">
                            <svg width="18" height="18" viewBox="0 0 18 18" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M3 3H15V15H3V3Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M3 6H15M6 3V15" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                            </svg>
                            <span>Property</span>
                        </div>
                    </div>
                    <div class="filter-card-body">
                        <div class="listing-filter-wrapper">
                            <button type="button" id="listingFilterTrigger" class="modern-filter-trigger" onclick="toggleListingFilter(event)">
                                <span id="listingFilterText">All Properties</span>
                                <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="filter-arrow">
                                    <path d="M4 6L8 10L12 6" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                            </button>
                            <div id="listingFilterDropdown" class="modern-filter-dropdown" style="display: none;">
                                <div class="modern-filter-dropdown-header">
                                    <span>Select Properties</span>
                                    <div class="modern-filter-actions">
                                        <button type="button" onclick="selectAllListings()" class="filter-action-btn">All</button>
                                        <button type="button" onclick="deselectAllListings()" class="filter-action-btn">None</button>
                                    </div>
                                </div>
                                <div class="modern-filter-options" id="listingFilterOptions">
                                    <label class="modern-filter-option">
                                        <input type="checkbox" class="listing-checkbox" value="0">
                                        <span class="modern-checkbox-custom"></span>
                                        <span>General (No Property)</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                        <div id="selectedListingsDisplay" class="selected-listings-display"></div>
                    </div>
                </div>
                
                <!-- Status Filter -->
                <div class="filter-card">
                    <div class="filter-card-header">
                        <div class="filter-card-title">
                            <svg width="18" height="18" viewBox="0 0 18 18" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <circle cx="9" cy="9" r="6" stroke="currentColor" stroke-width="1.5"/>
                                <path d="M9 5V9L12 12" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                            </svg>
                            <span>Status</span>
                        </div>
                    </div>
                    <div class="filter-card-body">
                        <div class="status-filter-wrapper">
                            <button type="button" id="statusFilterTrigger" class="modern-filter-trigger" onclick="toggleStatusFilter(event)">
                                <span id="statusFilterText">All Statuses</span>
                                <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="filter-arrow">
                                    <path d="M4 6L8 10L12 6" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                            </button>
                            <div id="statusFilterDropdown" class="modern-filter-dropdown" style="display: none;">
                                <div class="modern-filter-dropdown-header">
                                    <span>Select Statuses</span>
                                    <div class="modern-filter-actions">
                                        <button type="button" onclick="selectAllStatuses()" class="filter-action-btn">All</button>
                                        <button type="button" onclick="deselectAllStatuses()" class="filter-action-btn">None</button>
                                    </div>
                                </div>
                                <div class="modern-filter-options">
                                    <label class="modern-filter-option">
                                        <input type="checkbox" class="status-checkbox" value="Open" checked>
                                        <span class="modern-checkbox-custom"></span>
                                        <span>Open</span>
                                    </label>
                                    <label class="modern-filter-option">
                                        <input type="checkbox" class="status-checkbox" value="Assigned" checked>
                                        <span class="modern-checkbox-custom"></span>
                                        <span>Assigned</span>
                                    </label>
                                    <label class="modern-filter-option">
                                        <input type="checkbox" class="status-checkbox" value="In Progress" checked>
                                        <span class="modern-checkbox-custom"></span>
                                        <span>In Progress</span>
                                    </label>
                                    <label class="modern-filter-option">
                                        <input type="checkbox" class="status-checkbox" value="Blocked" checked>
                                        <span class="modern-checkbox-custom"></span>
                                        <span>Blocked</span>
                                    </label>
                                    <label class="modern-filter-option">
                                        <input type="checkbox" class="status-checkbox" value="Resolved" checked>
                                        <span class="modern-checkbox-custom"></span>
                                        <span>Resolved</span>
                                    </label>
                                    <label class="modern-filter-option">
                                        <input type="checkbox" class="status-checkbox" value="Closed" checked>
                                        <span class="modern-checkbox-custom"></span>
                                        <span>Closed</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Assigned To Filter -->
                <div class="filter-card">
                    <div class="filter-card-header">
                        <div class="filter-card-title">
                            <svg width="18" height="18" viewBox="0 0 18 18" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <circle cx="9" cy="6" r="3" stroke="currentColor" stroke-width="1.5"/>
                                <path d="M3 15C3 12.5 5.5 10.5 9 10.5C12.5 10.5 15 12.5 15 15" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                            </svg>
                            <span>Assigned To</span>
                        </div>
                    </div>
                    <div class="filter-card-body">
                        <select id="filterAssigned" class="modern-select">
                            <option value="">All Users</option>
                        </select>
                    </div>
                </div>
                
                <!-- Priority Filter -->
                <div class="filter-card">
                    <div class="filter-card-header">
                        <div class="filter-card-title">
                            <svg width="18" height="18" viewBox="0 0 18 18" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M9 2L11.5 7H16.5L12.5 10.5L14 16L9 13L4 16L5.5 10.5L1.5 7H6.5L9 2Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            <span>Priority</span>
                        </div>
                    </div>
                    <div class="filter-card-body">
                        <div class="priority-filter-wrapper">
                            <button type="button" id="priorityFilterTrigger" class="modern-filter-trigger" onclick="togglePriorityFilter(event)">
                                <span id="priorityFilterText">All Priorities</span>
                                <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="filter-arrow">
                                    <path d="M4 6L8 10L12 6" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                            </button>
                            <div id="priorityFilterDropdown" class="modern-filter-dropdown" style="display: none;">
                                <div class="modern-filter-dropdown-header">
                                    <span>Select Priorities</span>
                                    <div class="modern-filter-actions">
                                        <button type="button" onclick="selectAllPriorities()" class="filter-action-btn">All</button>
                                        <button type="button" onclick="deselectAllPriorities()" class="filter-action-btn">None</button>
                                    </div>
                                </div>
                                <div class="modern-filter-options">
                                    <label class="modern-filter-option">
                                        <input type="checkbox" class="priority-checkbox" value="Low" checked>
                                        <span class="modern-checkbox-custom"></span>
                                        <span>Low</span>
                                    </label>
                                    <label class="modern-filter-option">
                                        <input type="checkbox" class="priority-checkbox" value="Medium" checked>
                                        <span class="modern-checkbox-custom"></span>
                                        <span>Medium</span>
                                    </label>
                                    <label class="modern-filter-option">
                                        <input type="checkbox" class="priority-checkbox" value="High" checked>
                                        <span class="modern-checkbox-custom"></span>
                                        <span>High</span>
                                    </label>
                                    <label class="modern-filter-option">
                                        <input type="checkbox" class="priority-checkbox" value="Critical" checked>
                                        <span class="modern-checkbox-custom"></span>
                                        <span>Critical</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
        </div>
        
                <!-- Category Filter -->
                <div class="filter-card">
                    <div class="filter-card-header">
                        <div class="filter-card-title">
                            <svg width="18" height="18" viewBox="0 0 18 18" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M3 3H8V8H3V3Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M10 3H15V8H10V3Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M3 10H8V15H3V10Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M10 10H15V15H10V10Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            <span>Category</span>
                        </div>
                    </div>
                    <div class="filter-card-body">
                        <select id="filterCategory" class="modern-select">
                <option value="">All Categories</option>
                <option value="cleaning">Cleaning</option>
                <option value="maintenance">Maintenance</option>
                <option value="online">Online</option>
                            <option value="technology">Technology</option>
                            <option value="review management">Review Management</option>
                <option value="other">Other</option>
            </select>
                    </div>
        </div>
        
                <!-- Past Due Filter -->
                <div class="filter-card">
                    <div class="filter-card-header">
                        <div class="filter-card-title">
                            <svg width="18" height="18" viewBox="0 0 18 18" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <circle cx="9" cy="9" r="7.5" stroke="currentColor" stroke-width="1.5"/>
                                <path d="M9 5V9L12 12" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            <span>Past Due</span>
                        </div>
                    </div>
                    <div class="filter-card-body">
                        <label class="modern-filter-option" style="cursor: pointer; padding: 0.5rem 0;">
                            <input type="checkbox" id="filterPastDue" class="past-due-checkbox" style="display: none;">
                            <span class="modern-checkbox-custom"></span>
                            <span>Show only past due tickets</span>
                        </label>
                    </div>
                </div>
                
                <!-- Due Within Filter -->
                <div class="filter-card">
                    <div class="filter-card-header">
                        <div class="filter-card-title">
                            <svg width="18" height="18" viewBox="0 0 18 18" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <circle cx="9" cy="9" r="7.5" stroke="currentColor" stroke-width="1.5"/>
                                <path d="M9 5V9L12 12" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            <span>Due Within</span>
                        </div>
                    </div>
                    <div class="filter-card-body">
                        <input type="number" id="filterDueDays" class="modern-input" placeholder="Days" min="1" max="365" style="width: 100%;">
                        <p style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 0.5rem;">Show tickets due in the next X days</p>
                    </div>
                </div>
                
                <!-- Re-occurring Filter -->
                <div class="filter-card">
                    <div class="filter-card-header">
                        <div class="filter-card-title">
                            <svg width="18" height="18" viewBox="0 0 18 18" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M9 2L9.5 6.5L14 7L9.5 7.5L9 12L8.5 7.5L4 7L8.5 6.5L9 2Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                <circle cx="9" cy="9" r="6" stroke="currentColor" stroke-width="1.5" stroke-dasharray="2 2"/>
                            </svg>
                            <span>Re-occurring</span>
                        </div>
                    </div>
                    <div class="filter-card-body">
                        <label class="modern-filter-option" style="cursor: pointer; padding: 0.5rem 0;">
                            <input type="checkbox" id="filterRecurring" class="recurring-checkbox" style="display: none;">
                            <span class="modern-checkbox-custom"></span>
                            <span>Show only re-occurring tickets</span>
                        </label>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="tagFilterContainer" class="tag-filter" style="margin-top: 1rem;"></div>
    
    <div id="loading" class="loading" style="display: none;">
        Loading tickets...
    </div>
    
    <div id="ticketsContainer" class="tickets-container">
        <!-- Tickets will be loaded here -->
    </div>
    
    <div id="swimLaneContainer" class="swimlane-container" style="display: none;">
        <!-- Swim lane board will be loaded here -->
    </div>
    
    <div id="noTickets" class="no-results" style="display: none;">
        No tickets found.
    </div>
</div>

<script src="/static/js/tags.js"></script>
<script>
let allListings = [];
let allUsers = [];
let tagFilter = null;
let selectedTagIds = [];
let tagLogic = 'AND';
let searchTimeout = null;
let currentView = localStorage.getItem('ticketView') || 'list'; // 'list' or 'swimlane'

// Function to apply filters from URL parameters
function applyFiltersFromUrl() {
    const urlParams = new URLSearchParams(window.location.search);
    const assignedUserIdParam = urlParams.get('assigned_user_id');
    
    // Apply status filter (comma-separated)
    const statusParam = urlParams.get('status');
    if (statusParam) {
        const statuses = statusParam.split(',').map(s => s.trim());
        // First uncheck all status checkboxes
        document.querySelectorAll('.status-checkbox').forEach(cb => {
            cb.checked = false;
        });
        // Then check the ones from URL
        statuses.forEach(status => {
            const checkbox = document.querySelector(`.status-checkbox[value="${status}"]`);
            if (checkbox) {
                checkbox.checked = true;
            }
        });
        updateStatusFilterText();
    }
    
    // Apply priority filter (comma-separated)
    const priorityParam = urlParams.get('priority');
    if (priorityParam) {
        const priorities = priorityParam.split(',').map(p => p.trim());
        // First uncheck all priority checkboxes
        document.querySelectorAll('.priority-checkbox').forEach(cb => {
            cb.checked = false;
        });
        // Then check the ones from URL
        priorities.forEach(priority => {
            const checkbox = document.querySelector(`.priority-checkbox[value="${priority}"]`);
            if (checkbox) {
                checkbox.checked = true;
            } else {
                console.warn(`Priority checkbox not found for value: ${priority}`);
            }
        });
        updatePriorityFilterText();
    }
    
    // Apply past_due filter
    const pastDueParam = urlParams.get('past_due');
    if (pastDueParam === 'true') {
        const pastDueCheckbox = document.getElementById('filterPastDue');
        if (pastDueCheckbox) {
            pastDueCheckbox.checked = true;
        }
    }
    
    // Apply due_days filter
    const dueDaysParam = urlParams.get('due_days');
    if (dueDaysParam) {
        const dueDaysInput = document.getElementById('filterDueDays');
        if (dueDaysInput) {
            dueDaysInput.value = dueDaysParam;
        }
    }
    
    // Apply recurring filter
    const recurringParam = urlParams.get('recurring');
    if (recurringParam === 'true') {
        const recurringCheckbox = document.getElementById('filterRecurring');
        if (recurringCheckbox) {
            recurringCheckbox.checked = true;
        }
    }
    
    // Apply assigned_user_id filter
    // Note: loadUsers() should have already set this, but we verify/ensure it's set here
    // assignedUserIdParam was already declared above, so we just use it here
    if (assignedUserIdParam) {
        const assignedSelect = document.getElementById('filterAssigned');
        if (assignedSelect) {
            // Try to set it - check both exact match and loose equality (for string/number mismatch)
            const option = assignedSelect.querySelector(`option[value="${assignedUserIdParam}"]`) || 
                          Array.from(assignedSelect.options).find(opt => opt.value == assignedUserIdParam);
            if (option) {
                assignedSelect.value = assignedUserIdParam;
            }
        }
    }
}

// Load data on page load
document.addEventListener('DOMContentLoaded', function() {
    // Initialize tag filter
    tagFilter = new TagFilter('#tagFilterContainer', {
        endpoint: '/api/tags',
        onFilterChange: (tagIds, logic) => {
            selectedTagIds = tagIds;
            tagLogic = logic;
            loadTickets();
        }
    });
    
    loadListings();
    
    // Load users first, then apply filters from URL, then load tickets
    loadUsers().then(() => {
        // Ensure assigned_user_id is set from URL (loadUsers() should have set it, but double-check)
        const urlParams = new URLSearchParams(window.location.search);
        const assignedUserId = urlParams.get('assigned_user_id');
        const selectAfterLoad = document.getElementById('filterAssigned');
        if (assignedUserId && selectAfterLoad) {
            // Verify the value is set correctly
            if (selectAfterLoad.value !== assignedUserId) {
                // Try to set it again
                const option = selectAfterLoad.querySelector(`option[value="${assignedUserId}"]`) || 
                              Array.from(selectAfterLoad.options).find(opt => opt.value == assignedUserId);
                if (option) {
                    selectAfterLoad.value = assignedUserId;
                }
            }
        }
        
        // Apply filters from URL parameters after users are loaded
        applyFiltersFromUrl();
        
        // Update filter text displays after applying filters
        updateStatusFilterText();
        updateListingFilterText();
        updatePriorityFilterText();
        
        // Use requestAnimationFrame to ensure DOM is updated before loading tickets
        requestAnimationFrame(() => {
            // Small delay to ensure checkboxes are fully updated
            setTimeout(() => {
                loadTickets();
            }, 50);
        });
    }).catch(() => {
        // Even if users fail to load, still apply other filters and load tickets
        applyFiltersFromUrl();
        
        // Update filter text displays after applying filters
        updateStatusFilterText();
        updateListingFilterText();
        updatePriorityFilterText();
        
        // Use requestAnimationFrame to ensure DOM is updated before loading tickets
        requestAnimationFrame(() => {
            // Small delay to ensure checkboxes are fully updated
            setTimeout(() => {
                loadTickets();
            }, 50);
        });
    });
    
    // Add change listeners to status checkboxes
    document.querySelectorAll('.status-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            updateStatusFilterText();
            updateActiveFilters();
            loadTickets();
        });
    });
    
    // Add search input event listener with debouncing
    const searchInput = document.getElementById('searchInput');
    const clearSearchBtn = document.getElementById('clearSearchBtn');
    if (searchInput) {
        searchInput.addEventListener('input', function() {
            // Show/hide clear button based on input
            if (clearSearchBtn) {
                clearSearchBtn.style.display = this.value.trim() ? 'flex' : 'none';
            }
            
            // Clear existing timeout
            if (searchTimeout) {
                clearTimeout(searchTimeout);
            }
            
            // Update active filters immediately (no debounce for UI feedback)
            updateActiveFilters();
            
            // Set new timeout for debounced search
            searchTimeout = setTimeout(function() {
                loadTickets();
            }, 400); // 400ms debounce delay
        });
        
        // Handle focus
        searchInput.addEventListener('focus', function() {
            this.parentElement.classList.add('focused');
        });
        
        searchInput.addEventListener('blur', function() {
            this.parentElement.classList.remove('focused');
        });
    }
    
    // Add change listeners to select dropdowns
    const filterAssigned = document.getElementById('filterAssigned');
    const filterCategory = document.getElementById('filterCategory');
    
    if (filterAssigned) {
        filterAssigned.addEventListener('change', function() {
            updateActiveFilters();
            loadTickets();
        });
    }
    
    // Add change listeners to priority checkboxes
    document.querySelectorAll('.priority-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            updatePriorityFilterText();
            updateActiveFilters();
            loadTickets();
        });
    });
    
    if (filterCategory) {
        filterCategory.addEventListener('change', function() {
            updateActiveFilters();
            loadTickets();
        });
    }
    
    // Add change listener for past due checkbox
    const filterPastDue = document.getElementById('filterPastDue');
    if (filterPastDue) {
        filterPastDue.addEventListener('change', function() {
            updateActiveFilters();
            loadTickets();
        });
    }
    
    // Add change listener for recurring checkbox
    const filterRecurring = document.getElementById('filterRecurring');
    if (filterRecurring) {
        filterRecurring.addEventListener('change', function() {
            updateActiveFilters();
            loadTickets();
        });
    }
    
    // Close dropdowns when clicking outside
    document.addEventListener('click', function(event) {
        // Close status filter dropdown
        const statusDropdown = document.getElementById('statusFilterDropdown');
        const statusTrigger = document.getElementById('statusFilterTrigger');
        const statusWrapper = statusTrigger ? statusTrigger.closest('.status-filter-wrapper') : null;
        
        if (statusWrapper && statusDropdown && statusTrigger && 
            !statusWrapper.contains(event.target) && 
            statusDropdown.style.display !== 'none') {
            statusDropdown.style.display = 'none';
            statusTrigger.classList.remove('active');
        }
        
        // Close listing filter dropdown
        const listingDropdown = document.getElementById('listingFilterDropdown');
        const listingTrigger = document.getElementById('listingFilterTrigger');
        const listingWrapper = listingTrigger ? listingTrigger.closest('.listing-filter-wrapper') : null;
        
        if (listingWrapper && listingDropdown && listingTrigger && 
            !listingWrapper.contains(event.target) && 
            listingDropdown.style.display !== 'none') {
            listingDropdown.style.display = 'none';
            listingTrigger.classList.remove('active');
        }
        
        // Close priority filter dropdown
        const priorityDropdown = document.getElementById('priorityFilterDropdown');
        const priorityTrigger = document.getElementById('priorityFilterTrigger');
        const priorityWrapper = priorityTrigger ? priorityTrigger.closest('.priority-filter-wrapper') : null;
        
        if (priorityWrapper && priorityDropdown && priorityTrigger && 
            !priorityWrapper.contains(event.target) && 
            priorityDropdown.style.display !== 'none') {
            priorityDropdown.style.display = 'none';
            priorityTrigger.classList.remove('active');
        }
    });
    
    // Initialize filter text (will be updated again after URL filters are applied)
    updateStatusFilterText();
    updateListingFilterText();
    updatePriorityFilterText();
    
    // Initialize view based on saved preference
    toggleView(currentView, false); // false = don't save to localStorage yet
});

function toggleFiltersPanel() {
    const panel = document.getElementById('filtersPanel');
    const arrow = document.getElementById('filtersToggleArrow');
    const btn = document.getElementById('filtersToggleBtn');
    const isOpen = panel && panel.style.display !== 'none';
    
    if (panel) {
        panel.style.display = isOpen ? 'none' : 'block';
    }
    if (arrow) {
        arrow.style.transform = isOpen ? 'rotate(0deg)' : 'rotate(180deg)';
    }
    if (btn) {
        btn.classList.toggle('active', !isOpen);
    }
}

function toggleStatusFilter(event) {
    if (event) {
        event.stopPropagation();
    }
    const dropdown = document.getElementById('statusFilterDropdown');
    const trigger = document.getElementById('statusFilterTrigger');
    
    if (dropdown && trigger) {
        const isOpen = dropdown.style.display !== 'none' && dropdown.style.display !== '';
        dropdown.style.display = isOpen ? 'none' : 'block';
        trigger.classList.toggle('active', !isOpen);
    }
}

function updateStatusFilterText() {
    const checkboxes = document.querySelectorAll('.status-checkbox:checked');
    const textElement = document.getElementById('statusFilterText');
    
    if (checkboxes.length === 0) {
        textElement.textContent = 'No Statuses';
    } else if (checkboxes.length === 6) {
        textElement.textContent = 'All Statuses';
    } else if (checkboxes.length === 1) {
        textElement.textContent = checkboxes[0].value;
    } else {
        textElement.textContent = `${checkboxes.length} Selected`;
    }
    updateActiveFilters();
}

function togglePriorityFilter(event) {
    if (event) {
        event.stopPropagation();
    }
    const dropdown = document.getElementById('priorityFilterDropdown');
    const trigger = document.getElementById('priorityFilterTrigger');
    
    if (dropdown && trigger) {
        const isOpen = dropdown.style.display !== 'none' && dropdown.style.display !== '';
        dropdown.style.display = isOpen ? 'none' : 'block';
        trigger.classList.toggle('active', !isOpen);
    }
}

function updatePriorityFilterText() {
    const checkboxes = document.querySelectorAll('.priority-checkbox:checked');
    const textElement = document.getElementById('priorityFilterText');
    if (!textElement) return;
    
    if (checkboxes.length === 0) {
        textElement.textContent = 'No Priorities';
    } else if (checkboxes.length === 4) {
        textElement.textContent = 'All Priorities';
    } else if (checkboxes.length === 1) {
        textElement.textContent = checkboxes[0].value;
    } else {
        // Show selected priorities as comma-separated list
        const selectedValues = Array.from(checkboxes).map(cb => cb.value).join(', ');
        textElement.textContent = selectedValues;
    }
    updateActiveFilters();
}

function selectAllPriorities() {
    document.querySelectorAll('.priority-checkbox').forEach(cb => cb.checked = true);
    updatePriorityFilterText();
    updateActiveFilters();
    loadTickets();
}

function deselectAllPriorities() {
    document.querySelectorAll('.priority-checkbox').forEach(cb => cb.checked = false);
    updatePriorityFilterText();
    updateActiveFilters();
    loadTickets();
}

function toggleListingFilter(event) {
    if (event) {
        event.stopPropagation();
    }
    const dropdown = document.getElementById('listingFilterDropdown');
    const trigger = document.getElementById('listingFilterTrigger');
    
    if (dropdown && trigger) {
        const isOpen = dropdown.style.display !== 'none' && dropdown.style.display !== '';
        dropdown.style.display = isOpen ? 'none' : 'block';
        trigger.classList.toggle('active', !isOpen);
        
        // Ensure listings are loaded if dropdown is opening
        if (!isOpen && allListings.length === 0) {
            loadListings();
        }
    }
}

function updateListingFilterText() {
    const checkboxes = document.querySelectorAll('.listing-checkbox:checked');
    const textElement = document.getElementById('listingFilterText');
    if (!textElement) return;
    
    if (checkboxes.length === 0) {
        textElement.textContent = 'All Properties';
    } else if (checkboxes.length === 1) {
        const checkbox = checkboxes[0];
        if (checkbox.value === '0') {
            textElement.textContent = 'General (No Property)';
        } else {
            const listing = allListings.find(l => l.listing_id == checkbox.value);
            textElement.textContent = listing ? (listing.internal_listing_name || listing.name || `Listing ${listing.listing_id}`) : 'Selected';
        }
    } else {
        textElement.textContent = `${checkboxes.length} Selected`;
    }
}

function selectAllListings() {
    document.querySelectorAll('.listing-checkbox').forEach(cb => cb.checked = true);
    updateListingFilterText();
    updateActiveFilters();
    loadTickets();
}

function deselectAllListings() {
    document.querySelectorAll('.listing-checkbox').forEach(cb => cb.checked = false);
    updateListingFilterText();
    updateActiveFilters();
    loadTickets();
}

function loadListings() {
    fetch('/api/listings')
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(listings => {
            allListings = listings || [];
            
            // Populate listing filter dropdown
            const optionsContainer = document.getElementById('listingFilterOptions');
            if (!optionsContainer) {
                console.error('listingFilterOptions container not found');
                return;
            }
            
            // Clear existing options and rebuild with "General" option first
            optionsContainer.innerHTML = '';
            
            // Add "General (No Property)" option
            const generalLabel = document.createElement('label');
            generalLabel.className = 'modern-filter-option';
            
            const generalCheckbox = document.createElement('input');
            generalCheckbox.type = 'checkbox';
            generalCheckbox.className = 'listing-checkbox';
            generalCheckbox.value = '0';
            generalCheckbox.addEventListener('change', function() {
                updateListingFilterText();
                updateActiveFilters();
                loadTickets();
            });
            
            const generalCustomCheckbox = document.createElement('span');
            generalCustomCheckbox.className = 'modern-checkbox-custom';
            
            const generalLabelText = document.createElement('span');
            generalLabelText.textContent = 'General (No Property)';
            
            generalLabel.appendChild(generalCheckbox);
            generalLabel.appendChild(generalCustomCheckbox);
            generalLabel.appendChild(generalLabelText);
            optionsContainer.appendChild(generalLabel);
            
            // Add listings as checkboxes
            allListings.forEach(listing => {
                const label = document.createElement('label');
                label.className = 'modern-filter-option';
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.className = 'listing-checkbox';
                checkbox.value = listing.listing_id;
                checkbox.addEventListener('change', function() {
                    updateListingFilterText();
                    updateActiveFilters();
                    loadTickets();
                });
                
                const customCheckbox = document.createElement('span');
                customCheckbox.className = 'modern-checkbox-custom';
                
                const labelText = document.createElement('span');
                labelText.textContent = listing.internal_listing_name || listing.name || `Listing ${listing.listing_id}`;
                
                label.appendChild(checkbox);
                label.appendChild(customCheckbox);
                label.appendChild(labelText);
                optionsContainer.appendChild(label);
            });
            
            console.log(`Loaded ${allListings.length} listings`);
        })
        .catch(error => {
            console.error('Error loading listings:', error);
            // Show error to user
            const optionsContainer = document.getElementById('listingFilterOptions');
            if (optionsContainer) {
                const errorMsg = document.createElement('div');
                errorMsg.className = 'error';
                errorMsg.textContent = 'Failed to load listings. Please refresh the page.';
                errorMsg.style.margin = '0.5rem 0';
                optionsContainer.appendChild(errorMsg);
            }
        });
}

function loadUsers() {
    const select = document.getElementById('filterAssigned');
    if (!select) {
        console.error('filterAssigned select element not found');
        return Promise.resolve();
    }
    
    return fetch('/tickets/api/users')
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(users => {
            allUsers = users || [];
            // Clear existing options except "All Users"
            while (select.options.length > 1) {
                select.remove(1);
            }
            
            // Add users
            allUsers.forEach(user => {
                const option = document.createElement('option');
                option.value = user.user_id;
                option.textContent = user.name || user.email || `User ${user.user_id}`;
                select.appendChild(option);
            });
            
            console.log(`Loaded ${allUsers.length} users`);
            
            // Apply assigned_user_id filter from URL after users are loaded
            const urlParams = new URLSearchParams(window.location.search);
            const assignedUserId = urlParams.get('assigned_user_id');
            if (assignedUserId) {
                // Try to find the option - check both string and number comparison
                const option = select.querySelector(`option[value="${assignedUserId}"]`) || 
                              Array.from(select.options).find(opt => opt.value == assignedUserId);
                if (option) {
                    select.value = assignedUserId;
                }
            }
        })
        .catch(error => {
            console.error('Error loading users:', error);
            // Show error to user
            const errorMsg = document.createElement('div');
            errorMsg.className = 'error';
            errorMsg.textContent = 'Failed to load users. Please refresh the page.';
            errorMsg.style.margin = '0.5rem 0';
            select.parentElement.appendChild(errorMsg);
        });
}

function loadTickets() {
    const loading = document.getElementById('loading');
    const container = document.getElementById('ticketsContainer');
    const noTickets = document.getElementById('noTickets');
    
    loading.style.display = 'block';
    container.innerHTML = '';
    
    const params = new URLSearchParams();
    // Get selected listing IDs from checkboxes
    const listingCheckboxes = document.querySelectorAll('.listing-checkbox:checked');
    const selectedListingIds = Array.from(listingCheckboxes).map(cb => cb.value);
    const assignedSelect = document.getElementById('filterAssigned');
    let assignedId = assignedSelect ? assignedSelect.value : '';
    
    // Fallback: If dropdown value is empty but URL has assigned_user_id, use URL parameter
    // This handles the case where loadTickets() is called before the dropdown value is set
    if (!assignedId) {
        const urlParams = new URLSearchParams(window.location.search);
        const urlAssignedId = urlParams.get('assigned_user_id');
        if (urlAssignedId) {
            assignedId = urlAssignedId;
            // Try to set the dropdown value if the option exists
            if (assignedSelect) {
                const option = assignedSelect.querySelector(`option[value="${urlAssignedId}"]`) || 
                              Array.from(assignedSelect.options).find(opt => opt.value == urlAssignedId);
                if (option) {
                    assignedSelect.value = urlAssignedId;
                }
            }
        }
    }
    const statusCheckboxes = document.querySelectorAll('.status-checkbox:checked');
    const selectedStatuses = Array.from(statusCheckboxes).map(cb => cb.value);
    const priorityCheckboxes = document.querySelectorAll('.priority-checkbox:checked');
    const selectedPriorities = Array.from(priorityCheckboxes).map(cb => cb.value);
    
    // Debug: Log selected priorities and assigned user
    console.log('Selected priorities from checkboxes:', selectedPriorities);
    console.log('Assigned user ID from dropdown:', assignedId);
    
    const category = document.getElementById('filterCategory').value;
    const pastDue = document.getElementById('filterPastDue').checked;
    const recurring = document.getElementById('filterRecurring').checked;
    const searchQuery = document.getElementById('searchInput').value.trim();
    const dueDaysEl = document.getElementById('filterDueDays');
    const dueDays = dueDaysEl ? dueDaysEl.value : '';
    
    // Add listing filter - send as comma-separated listing_ids
    if (selectedListingIds.length > 0) {
        params.append('listing_ids', selectedListingIds.join(','));
    }
    if (assignedId) {
        params.append('assigned_user_id', assignedId);
    }
    if (selectedStatuses.length > 0) {
        // Send multiple status values as comma-separated string
        params.append('status', selectedStatuses.join(','));
    }
    if (selectedPriorities.length > 0) {
        // Send multiple priority values as comma-separated string
        params.append('priority', selectedPriorities.join(','));
        console.log('Adding priority filter to API request:', selectedPriorities.join(','));
    } else {
        console.log('No priorities selected - will show all tickets');
    }
    if (category) params.append('category', category);
    if (pastDue) params.append('past_due', 'true');
    if (recurring) params.append('recurring', 'true');
    if (dueDays && parseInt(dueDays) > 0) {
        params.append('due_days', dueDays);
    }
    if (searchQuery) params.append('search', searchQuery);
    
    // Add tag filters
    if (selectedTagIds.length > 0 && tagFilter) {
        const selectedTags = tagFilter.allTags.filter(t => selectedTagIds.includes(t.tag_id));
        if (selectedTags.length > 0) {
            params.append('tags', selectedTags.map(t => t.name).join(','));
            params.append('tag_logic', tagLogic);
        }
    }
    
    fetch(`/tickets/api/tickets?${params.toString()}`)
        .then(response => response.json())
        .then(tickets => {
            loading.style.display = 'none';
            
            if (tickets.length === 0) {
                noTickets.style.display = 'block';
                if (currentView === 'swimlane') {
                    document.getElementById('swimLaneContainer').innerHTML = '<div class="no-results">No tickets found.</div>';
                }
                return;
            }
            
            noTickets.style.display = 'none';
            
            // Deduplicate tickets by ticket_id before rendering
            const seenIds = new Set();
            const uniqueTickets = tickets.filter(ticket => {
                if (seenIds.has(ticket.ticket_id)) {
                    return false;
                }
                seenIds.add(ticket.ticket_id);
                return true;
            });
            
            // Render based on current view
            if (currentView === 'swimlane') {
                renderSwimLaneView(uniqueTickets);
            } else {
            uniqueTickets.forEach(ticket => {
                const card = createTicketCard(ticket);
                container.appendChild(card);
            });
            }
        })
        .catch(error => {
            loading.style.display = 'none';
            container.innerHTML = `<div class="error">Error loading tickets: ${error.message}</div>`;
        });
}

function createTicketCard(ticket) {
    const card = document.createElement('div');
    card.className = 'ticket-card';
    
    // Get listing names - support multiple listings
    let listingName = 'General';
    if (ticket.listings && ticket.listings.length > 0) {
        // Multiple listings - show all
        const listingNames = ticket.listings.map(l => 
            l.internal_listing_name || l.name || `Listing ${l.listing_id}`
        );
        listingName = listingNames.join(', ');
    } else if (ticket.listing_id) {
        // Fallback to single listing (backward compatibility)
        if (ticket.listing) {
            // Use listing info from API response (includes internal_listing_name)
            listingName = ticket.listing.internal_listing_name || ticket.listing.name || `Listing ${ticket.listing_id}`;
        } else {
            // Fallback to allListings lookup
    const listing = allListings.find(l => l.listing_id === ticket.listing_id);
            if (listing) {
                listingName = listing.internal_listing_name || listing.name || `Listing ${ticket.listing_id}`;
            } else {
                listingName = `Listing ${ticket.listing_id}`;
            }
        }
    }
    
    const statusClass = ticket.status.toLowerCase().replace(' ', '-');
    const priorityClass = ticket.priority.toLowerCase();
    const categoryClass = ticket.category ? ticket.category.toLowerCase() : 'other';
    
    const dueDate = ticket.due_date ? new Date(ticket.due_date) : null;
    const isOverdue = dueDate && dueDate < new Date() && ticket.status !== 'Resolved' && ticket.status !== 'Closed';
    
    const categoryDisplay = ticket.category ? ticket.category.charAt(0).toUpperCase() + ticket.category.slice(1) : 'Other';
    
    // Render tags
    let tagsHtml = '';
    if (ticket.tags && ticket.tags.length > 0) {
        tagsHtml = '<div class="ticket-card-tags tags-display" style="margin-top: 0.5rem;">';
        ticket.tags.forEach(tag => {
            const tagStyle = tag.color ? `style="background-color: ${tag.color}; border-color: ${tag.color};" class="tag-chip has-color"` : 'class="tag-chip"';
            const inheritedClass = tag.is_inherited ? ' tag-chip-inherited' : '';
            const title = tag.is_inherited ? ' title="Inherited from property"' : '';
            tagsHtml += `<span ${tagStyle}${inheritedClass}${title}>${escapeHtml(tag.name)}</span>`;
        });
        tagsHtml += '</div>';
    }
    
    // Check if recurring
    let recurringBadge = '';
    let nextOccurrenceHtml = '';
    if (ticket.is_recurring) {
        const recurrenceType = ticket.recurrence_type || 'frequency';
        const icons = {
            'frequency': '',
            'weekly': '',
            'monthly': '',
            'quarterly': '',
            'annual': ''
        };
        const icon = icons[recurrenceType] || '';
        const typeNames = {
            'frequency': 'Frequency',
            'weekly': 'Weekly',
            'monthly': 'Monthly',
            'quarterly': 'Quarterly',
            'annual': 'Annual'
        };
        const typeName = typeNames[recurrenceType] || 'Recurring';
        recurringBadge = `<span class="status-badge" style="background: #6366f1; color: white; font-size: 10px; padding: 2px 6px;" title="${typeName} recurring task">${icon} ${typeName}</span>`;
        
        // Display next occurrence date if available
        if (ticket.next_occurrence_date) {
            try {
                const nextOccurrenceDate = new Date(ticket.next_occurrence_date);
                if (!isNaN(nextOccurrenceDate.getTime())) {
                    nextOccurrenceHtml = `<span class="ticket-next-occurrence" style="font-size: 0.875rem; color: #6366f1; font-weight: 500;">Next: ${formatDate(nextOccurrenceDate)}</span>`;
                }
            } catch (e) {
                console.error('Error parsing next_occurrence_date:', e, ticket.next_occurrence_date);
            }
        }
    }
    
    card.innerHTML = `
        <div class="ticket-card-header">
                    <h3><a href="/tickets/${ticket.ticket_id}/page">${escapeHtml(ticket.title)}</a></h3>
            <div class="ticket-badges">
                <span class="status-badge status-${statusClass}">${escapeHtml(ticket.status)}</span>
                <span class="priority-badge priority-${priorityClass}">${escapeHtml(ticket.priority)}</span>
                <span class="category-badge category-${categoryClass}">${escapeHtml(categoryDisplay)}</span>
                ${recurringBadge}
            </div>
        </div>
        <div class="ticket-card-body">
            ${ticket.issue_title ? `<p class="ticket-issue">Issue: ${escapeHtml(ticket.issue_title)}</p>` : ''}
            <p class="ticket-listing">Property: ${escapeHtml(listingName)}</p>
            ${ticket.description ? `<p class="ticket-description">${escapeHtml(ticket.description.substring(0, 150))}${ticket.description.length > 150 ? '...' : ''}</p>` : ''}
            ${tagsHtml}
            <div class="ticket-meta">
                ${ticket.assigned_user_name ? `<span class="ticket-assigned">Assigned to: ${escapeHtml(ticket.assigned_user_name)}</span>` : '<span class="ticket-assigned">Unassigned</span>'}
                ${dueDate ? `<span class="ticket-due ${isOverdue ? 'overdue' : ''}">Due: ${formatDate(dueDate)}</span>` : ''}
                ${nextOccurrenceHtml}
            </div>
        </div>
        <div class="ticket-card-footer">
            <span class="ticket-created">Created ${formatDate(new Date(ticket.created_at))}</span>
            <a href="/tickets/${ticket.ticket_id}/page" class="btn-secondary">View Details</a>
        </div>
    `;
    
    return card;
}

function applyFilters() {
    loadTickets();
}

function selectAllStatuses() {
    document.querySelectorAll('.status-checkbox').forEach(cb => cb.checked = true);
    updateStatusFilterText();
    updateActiveFilters();
    loadTickets();
}

function deselectAllStatuses() {
    document.querySelectorAll('.status-checkbox').forEach(cb => cb.checked = false);
    updateStatusFilterText();
    updateActiveFilters();
    loadTickets();
}

function clearSearch() {
    const searchInput = document.getElementById('searchInput');
    const clearBtn = document.getElementById('clearSearchBtn');
    if (searchInput) {
        searchInput.value = '';
        if (clearBtn) clearBtn.style.display = 'none';
        // Clear any pending search timeout
        if (searchTimeout) {
            clearTimeout(searchTimeout);
            searchTimeout = null;
        }
        loadTickets();
    }
}

function updateActiveFilters() {
    const activeBar = document.getElementById('activeFiltersBar');
    const chipsContainer = document.getElementById('activeFiltersChips');
    if (!activeBar || !chipsContainer) return;
    
    chipsContainer.innerHTML = '';
    const activeFilters = [];
    
    // Check listing filters
    const listingCheckboxes = document.querySelectorAll('.listing-checkbox:checked');
    if (listingCheckboxes.length > 0) {
        listingCheckboxes.forEach(cb => {
            let label = '';
            if (cb.value === '0') {
                label = 'General (No Property)';
            } else {
                const listing = allListings.find(l => l.listing_id == cb.value);
                label = listing ? (listing.internal_listing_name || listing.name || `Listing ${listing.listing_id}`) : 'Unknown';
            }
            activeFilters.push({ type: 'listing', value: cb.value, label: label });
        });
    }
    
    // Check status filters
    const statusCheckboxes = document.querySelectorAll('.status-checkbox:checked');
    if (statusCheckboxes.length > 0 && statusCheckboxes.length < 6) {
        statusCheckboxes.forEach(cb => {
            activeFilters.push({ type: 'status', value: cb.value, label: cb.value });
        });
    }
    
    // Check assigned user
    const assignedId = document.getElementById('filterAssigned').value;
    if (assignedId) {
        const assignedSelect = document.getElementById('filterAssigned');
        const selectedOption = assignedSelect.options[assignedSelect.selectedIndex];
        activeFilters.push({ type: 'assigned', value: assignedId, label: selectedOption.text });
    }
    
    // Check priority (multi-choice)
    const priorityCheckboxes = document.querySelectorAll('.priority-checkbox:checked');
    if (priorityCheckboxes.length > 0 && priorityCheckboxes.length < 4) {
        priorityCheckboxes.forEach(cb => {
            activeFilters.push({ type: 'priority', value: cb.value, label: cb.value });
        });
    }
    
    // Check due_days
    const dueDays = document.getElementById('filterDueDays').value;
    if (dueDays && parseInt(dueDays) > 0) {
        activeFilters.push({ type: 'due_days', value: dueDays, label: `Due in ${dueDays} days` });
    }
    
    // Check category
    const category = document.getElementById('filterCategory').value;
    if (category) {
        activeFilters.push({ type: 'category', value: category, label: category.charAt(0).toUpperCase() + category.slice(1) });
    }
    
    // Check past due
    const pastDue = document.getElementById('filterPastDue');
    if (pastDue && pastDue.checked) {
        activeFilters.push({ type: 'past_due', value: 'true', label: 'Past Due' });
    }
    
    // Check recurring
    const recurring = document.getElementById('filterRecurring');
    if (recurring && recurring.checked) {
        activeFilters.push({ type: 'recurring', value: 'true', label: 'Re-occurring' });
    }
    
    // Check search
    const searchQuery = document.getElementById('searchInput').value.trim();
    if (searchQuery) {
        activeFilters.push({ type: 'search', value: searchQuery, label: `Search: "${searchQuery}"` });
    }
    
    // Display active filters
    if (activeFilters.length > 0) {
        activeBar.style.display = 'block';
        activeFilters.forEach(filter => {
            const chip = document.createElement('span');
            chip.className = 'active-filter-chip';
            
            const label = document.createElement('span');
            label.className = 'active-filter-label';
            label.textContent = filter.label;
            
            const removeBtn = document.createElement('button');
            removeBtn.type = 'button';
            removeBtn.className = 'active-filter-chip-remove';
            removeBtn.setAttribute('data-filter-type', filter.type);
            removeBtn.setAttribute('data-filter-value', filter.value);
            removeBtn.addEventListener('click', function() {
                removeActiveFilter(filter.type, filter.value);
            });
            
            const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
            svg.setAttribute('width', '12');
            svg.setAttribute('height', '12');
            svg.setAttribute('viewBox', '0 0 12 12');
            svg.setAttribute('fill', 'none');
            
            const path1 = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            path1.setAttribute('d', 'M9 3L3 9M3 3L9 9');
            path1.setAttribute('stroke', 'currentColor');
            path1.setAttribute('stroke-width', '1.5');
            path1.setAttribute('stroke-linecap', 'round');
            svg.appendChild(path1);
            
            removeBtn.appendChild(svg);
            chip.appendChild(label);
            chip.appendChild(removeBtn);
            chipsContainer.appendChild(chip);
        });
    } else {
        activeBar.style.display = 'none';
    }
}

function removeActiveFilter(type, value) {
    if (type === 'listing') {
        const checkbox = document.querySelector(`.listing-checkbox[value="${value}"]`);
        if (checkbox) {
            checkbox.checked = false;
            updateListingFilterText();
        }
    } else if (type === 'status') {
        const checkbox = document.querySelector(`.status-checkbox[value="${value}"]`);
        if (checkbox) {
            checkbox.checked = false;
            updateStatusFilterText();
        }
    } else if (type === 'assigned') {
        document.getElementById('filterAssigned').value = '';
    } else if (type === 'priority') {
        const checkbox = document.querySelector(`.priority-checkbox[value="${value}"]`);
        if (checkbox) {
            checkbox.checked = false;
            updatePriorityFilterText();
        }
    } else if (type === 'category') {
        document.getElementById('filterCategory').value = '';
    } else if (type === 'past_due') {
        document.getElementById('filterPastDue').checked = false;
    } else if (type === 'due_days') {
        document.getElementById('filterDueDays').value = '';
    } else if (type === 'recurring') {
        document.getElementById('filterRecurring').checked = false;
    } else if (type === 'search') {
        document.getElementById('searchInput').value = '';
        const clearBtn = document.getElementById('clearSearchBtn');
        if (clearBtn) clearBtn.style.display = 'none';
    }
    updateActiveFilters();
    loadTickets();
}

function clearAllFilters() {
    // Clear listing filter
    document.querySelectorAll('.listing-checkbox').forEach(cb => cb.checked = false);
    updateListingFilterText();
    document.getElementById('filterAssigned').value = '';
    // Select all statuses by default
    document.querySelectorAll('.status-checkbox').forEach(cb => cb.checked = true);
    updateStatusFilterText();
    // Select all priorities by default
    document.querySelectorAll('.priority-checkbox').forEach(cb => cb.checked = true);
    updatePriorityFilterText();
    document.getElementById('filterCategory').value = '';
    document.getElementById('filterPastDue').checked = false;
    document.getElementById('filterDueDays').value = '';
    document.getElementById('filterRecurring').checked = false;
    clearSearch();
    if (tagFilter) {
        tagFilter.clear();
    }
    selectedTagIds = [];
    tagLogic = 'AND';
    updateActiveFilters();
    loadTickets();
}

function clearFilters() {
    clearAllFilters();
}

function formatDate(date) {
    if (!date) return '';
    return new Date(date).toLocaleDateString('en-US', { 
        year: 'numeric', 
        month: 'short', 
        day: 'numeric' 
    });
}

function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function toggleView(view, savePreference = true) {
    currentView = view;
    
    const listContainer = document.getElementById('ticketsContainer');
    const swimLaneContainer = document.getElementById('swimLaneContainer');
    const listBtn = document.getElementById('viewToggleBtn');
    const swimBtn = document.getElementById('viewToggleBtnSwim');
    
    if (view === 'swimlane') {
        listContainer.style.display = 'none';
        swimLaneContainer.style.display = 'block';
        listBtn.classList.remove('active');
        swimBtn.classList.add('active');
    } else {
        listContainer.style.display = 'grid';
        swimLaneContainer.style.display = 'none';
        listBtn.classList.add('active');
        swimBtn.classList.remove('active');
    }
    
    if (savePreference) {
        localStorage.setItem('ticketView', view);
    }
    
    // Reload tickets to render in the correct view
    loadTickets();
}

function renderSwimLaneView(tickets) {
    const container = document.getElementById('swimLaneContainer');
    container.innerHTML = '';
    
    // Define status order
    const statusOrder = ['Open', 'Assigned', 'In Progress', 'Blocked', 'Resolved', 'Closed'];
    
    // Group tickets by assigned user and status
    const userTickets = {};
    const unassignedTickets = {};
    
    tickets.forEach(ticket => {
        const userId = ticket.assigned_user_id || 'unassigned';
        const userName = ticket.assigned_user_name || 'Unassigned';
        const status = ticket.status || 'Open';
        
        if (userId === 'unassigned') {
            if (!unassignedTickets[status]) {
                unassignedTickets[status] = [];
            }
            unassignedTickets[status].push(ticket);
        } else {
            if (!userTickets[userId]) {
                userTickets[userId] = {
                    name: userName,
                    tickets: {}
                };
            }
            if (!userTickets[userId].tickets[status]) {
                userTickets[userId].tickets[status] = [];
            }
            userTickets[userId].tickets[status].push(ticket);
        }
    });
    
    // Create table structure
    const table = document.createElement('table');
    table.className = 'swimlane-table';
    
    // Create header row with status columns
    const headerRow = document.createElement('thead');
    const headerTr = document.createElement('tr');
    const userHeader = document.createElement('th');
    userHeader.className = 'swimlane-user-header';
    userHeader.textContent = 'User';
    headerTr.appendChild(userHeader);
    
    statusOrder.forEach(status => {
        const th = document.createElement('th');
        th.className = `swimlane-status-header status-${status.toLowerCase().replace(' ', '-')}`;
        th.innerHTML = `
            <div class="status-header-content">
                <span class="status-name">${escapeHtml(status)}</span>
                <span class="status-count" id="count-${status}">0</span>
            </div>
        `;
        headerTr.appendChild(th);
    });
    
    headerRow.appendChild(headerTr);
    table.appendChild(headerRow);
    
    // Create body
    const tbody = document.createElement('tbody');
    
    // Add unassigned row first
    if (Object.keys(unassignedTickets).length > 0 || Object.keys(userTickets).length === 0) {
        const unassignedRow = createSwimLaneRow('unassigned', 'Unassigned', unassignedTickets, statusOrder);
        tbody.appendChild(unassignedRow);
    }
    
    // Add user rows
    Object.keys(userTickets).sort().forEach(userId => {
        const userData = userTickets[userId];
        const row = createSwimLaneRow(userId, userData.name, userData.tickets, statusOrder);
        tbody.appendChild(row);
    });
    
    table.appendChild(tbody);
    container.appendChild(table);
    
    // Update status counts
    statusOrder.forEach(status => {
        const count = tickets.filter(t => t.status === status).length;
        const countEl = document.getElementById(`count-${status}`);
        if (countEl) {
            countEl.textContent = count;
        }
    });
}

function createSwimLaneRow(userId, userName, ticketsByStatus, statusOrder) {
    const row = document.createElement('tr');
    row.className = 'swimlane-row';
    row.dataset.userId = userId;
    
    // User name cell
    const userCell = document.createElement('td');
    userCell.className = 'swimlane-user-cell';
    userCell.innerHTML = `
        <div class="swimlane-user-info">
            <div class="swimlane-user-name">${escapeHtml(userName)}</div>
            <div class="swimlane-user-count">${Object.values(ticketsByStatus).reduce((sum, arr) => sum + arr.length, 0)} tickets</div>
        </div>
    `;
    row.appendChild(userCell);
    
    // Status cells
    statusOrder.forEach(status => {
        const cell = document.createElement('td');
        cell.className = `swimlane-cell status-${status.toLowerCase().replace(' ', '-')}`;
        
        const tickets = ticketsByStatus[status] || [];
        const cellContent = document.createElement('div');
        cellContent.className = 'swimlane-cell-content';
        
        tickets.forEach(ticket => {
            const card = createSwimLaneCard(ticket);
            cellContent.appendChild(card);
        });
        
        cell.appendChild(cellContent);
        row.appendChild(cell);
    });
    
    return row;
}

function createSwimLaneCard(ticket) {
    const card = document.createElement('div');
    card.className = 'swimlane-ticket-card';
    card.dataset.ticketId = ticket.ticket_id;
    
    // Get listing names - limit to first listing for swim lane to keep cards compact
    let listingName = 'General';
    if (ticket.listings && ticket.listings.length > 0) {
        // For swim lane, show only the first listing to keep cards compact
        const firstListing = ticket.listings[0];
        listingName = firstListing.internal_listing_name || firstListing.name || `Listing ${firstListing.listing_id}`;
        // If there are more listings, add a count indicator
        if (ticket.listings.length > 1) {
            listingName += ` (+${ticket.listings.length - 1})`;
        }
    } else if (ticket.listing_id) {
        if (ticket.listing) {
            listingName = ticket.listing.internal_listing_name || ticket.listing.name || `Listing ${ticket.listing_id}`;
        } else {
            const listing = allListings.find(l => l.listing_id === ticket.listing_id);
            if (listing) {
                listingName = listing.internal_listing_name || listing.name || `Listing ${ticket.listing_id}`;
            } else {
                listingName = `Listing ${ticket.listing_id}`;
            }
        }
    }
    
    const priorityClass = ticket.priority.toLowerCase();
    const categoryClass = ticket.category ? ticket.category.toLowerCase() : 'other';
    const dueDate = ticket.due_date ? new Date(ticket.due_date) : null;
    const isOverdue = dueDate && dueDate < new Date() && ticket.status !== 'Resolved' && ticket.status !== 'Closed';
    
    const categoryDisplay = ticket.category ? ticket.category.charAt(0).toUpperCase() + ticket.category.slice(1) : 'Other';
    
    // Render tags (limited for swim lane)
    let tagsHtml = '';
    if (ticket.tags && ticket.tags.length > 0) {
        const displayTags = ticket.tags.slice(0, 2); // Show max 2 tags in swim lane
        tagsHtml = '<div class="swimlane-tags">';
        displayTags.forEach(tag => {
            const tagStyle = tag.color ? `style="background-color: ${tag.color}; border-color: ${tag.color};" class="swimlane-tag has-color"` : 'class="swimlane-tag"';
            tagsHtml += `<span ${tagStyle}>${escapeHtml(tag.name)}</span>`;
        });
        if (ticket.tags.length > 2) {
            tagsHtml += `<span class="swimlane-tag-more">+${ticket.tags.length - 2}</span>`;
        }
        tagsHtml += '</div>';
    }
    
    let recurringBadge = '';
    let nextOccurrenceHtml = '';
    if (ticket.is_recurring) {
        const recurrenceType = ticket.recurrence_type || 'frequency';
        const icons = {
            'frequency': '',
            'weekly': '',
            'monthly': '',
            'quarterly': '',
            'annual': ''
        };
        const icon = icons[recurrenceType] || '';
        const typeNames = {
            'frequency': 'Frequency',
            'weekly': 'Weekly',
            'monthly': 'Monthly',
            'quarterly': 'Quarterly',
            'annual': 'Annual'
        };
        const typeName = typeNames[recurrenceType] || 'Recurring';
        recurringBadge = `<span class="swimlane-recurring" title="${typeName} recurring task">${icon}</span>`;
        
        // Display next occurrence date if available
        if (ticket.next_occurrence_date) {
            try {
                const nextOccurrenceDate = new Date(ticket.next_occurrence_date);
                if (!isNaN(nextOccurrenceDate.getTime())) {
                    nextOccurrenceHtml = `<span class="swimlane-next-occurrence" style="font-size: 0.75rem; color: #6366f1; font-weight: 500;">Next: ${formatDate(nextOccurrenceDate)}</span>`;
                }
            } catch (e) {
                console.error('Error parsing next_occurrence_date:', e, ticket.next_occurrence_date);
            }
        }
    }
    
    card.innerHTML = `
        <div class="swimlane-card-header">
            <a href="/tickets/${ticket.ticket_id}/page" class="swimlane-card-title">${escapeHtml(ticket.title)}</a>
            ${recurringBadge}
        </div>
        <div class="swimlane-card-body">
            ${ticket.issue_title ? `<div class="swimlane-card-issue">${escapeHtml(ticket.issue_title)}</div>` : ''}
            <div class="swimlane-card-listing">${escapeHtml(listingName)}</div>
            ${tagsHtml}
        </div>
        <div class="swimlane-card-footer">
            <span class="swimlane-priority priority-${priorityClass}">${escapeHtml(ticket.priority)}</span>
            ${dueDate ? `<span class="swimlane-due ${isOverdue ? 'overdue' : ''}">${formatDate(dueDate)}</span>` : ''}
            ${nextOccurrenceHtml}
        </div>
    `;
    
    return card;
}
</script>
{% endblock %}
