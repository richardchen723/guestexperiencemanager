{% extends "base.html" %}

{% block title %}Ticket #{{ ticket.ticket_id }} - Hostaway Insights Dashboard{% endblock %}

{% block content %}
<div class="ticket-detail-page">
    <div class="ticket-detail-header">
        <div>
            <h2>Ticket #{{ ticket.ticket_id }}: {{ ticket.title }}</h2>
            <div class="ticket-badges">
                <span class="status-badge status-{{ ticket.status.lower().replace(' ', '-') }}">{{ ticket.status }}</span>
                <span class="priority-badge priority-{{ ticket.priority.lower() }}">{{ ticket.priority }}</span>
                {% if ticket.category %}
                <span class="category-badge category-{{ ticket.category }}">{{ ticket.category|title }}</span>
                {% else %}
                <span class="category-badge category-other">Other</span>
                {% endif %}
            </div>
        </div>
        <div class="ticket-actions">
            {% if current_user.user_id == ticket.created_by or current_user.user_id == ticket.assigned_user_id or current_user.is_admin() %}
            <a href="{{ url_for('tickets.ticket_edit_form', ticket_id=ticket.ticket_id) }}" class="btn-secondary">Edit</a>
            {% endif %}
            {% if current_user.is_admin() %}
            <button onclick="deleteTicket({{ ticket.ticket_id }})" class="btn-danger">Delete</button>
            {% endif %}
        </div>
    </div>
    
    <div class="ticket-detail-content">
        <div class="ticket-info">
            <div class="info-section">
                <h3>Details</h3>
                <div class="info-row">
                    <label>Issue:</label>
                    <span>{{ ticket.issue_title }}</span>
                </div>
                <div class="info-row">
                    <label>Property:</label>
                    <span>
                        {% if listing %}
                        <a href="/insights/{{ listing.listing_id }}">{{ listing.name }}</a>
                        {% else %}
                        Listing #{{ ticket.listing_id }}
                        {% endif %}
                    </span>
                </div>
                <div class="info-row">
                    <label>Description:</label>
                    <span>{{ ticket.description or 'No description' }}</span>
                </div>
                <div class="info-row">
                    <label>Status:</label>
                    <select id="statusSelect" onchange="updateStatus({{ ticket.ticket_id }})">
                        <option value="Open" {% if ticket.status == 'Open' %}selected{% endif %}>Open</option>
                        <option value="Assigned" {% if ticket.status == 'Assigned' %}selected{% endif %}>Assigned</option>
                        <option value="In Progress" {% if ticket.status == 'In Progress' %}selected{% endif %}>In Progress</option>
                        <option value="Blocked" {% if ticket.status == 'Blocked' %}selected{% endif %}>Blocked</option>
                        <option value="Resolved" {% if ticket.status == 'Resolved' %}selected{% endif %}>Resolved</option>
                        <option value="Closed" {% if ticket.status == 'Closed' %}selected{% endif %}>Closed</option>
                    </select>
                </div>
                <div class="info-row">
                    <label>Priority:</label>
                    <select id="prioritySelect" onchange="updatePriority({{ ticket.ticket_id }})">
                        <option value="Low" {% if ticket.priority == 'Low' %}selected{% endif %}>Low</option>
                        <option value="Medium" {% if ticket.priority == 'Medium' %}selected{% endif %}>Medium</option>
                        <option value="High" {% if ticket.priority == 'High' %}selected{% endif %}>High</option>
                        <option value="Critical" {% if ticket.priority == 'Critical' %}selected{% endif %}>Critical</option>
                    </select>
                </div>
                <div class="info-row">
                    <label>Category:</label>
                    <select id="categorySelect" onchange="updateCategory({{ ticket.ticket_id }})">
                        <option value="other" {% if not ticket.category or ticket.category == 'other' %}selected{% endif %}>Other</option>
                        <option value="cleaning" {% if ticket.category == 'cleaning' %}selected{% endif %}>Cleaning</option>
                        <option value="maintenance" {% if ticket.category == 'maintenance' %}selected{% endif %}>Maintenance</option>
                        <option value="online" {% if ticket.category == 'online' %}selected{% endif %}>Online</option>
                    </select>
                </div>
                <div class="info-row">
                    <label>Assigned To:</label>
                    <select id="assignedSelect" onchange="updateAssignment({{ ticket.ticket_id }})">
                        <option value="">Unassigned</option>
                    </select>
                </div>
                <div class="info-row">
                    <label>Due Date:</label>
                    <input type="date" id="dueDateInput" value="{{ ticket.due_date.strftime('%Y-%m-%d') if ticket.due_date else '' }}" onchange="updateDueDate({{ ticket.ticket_id }})">
                </div>
                <div class="info-row">
                    <label>Created:</label>
                    <span>{{ ticket.created_at.strftime('%Y-%m-%d %H:%M') if ticket.created_at else '' }}</span>
                </div>
                <div class="info-row">
                    <label>Created By:</label>
                    <span>{{ ticket.creator.name if ticket.creator else 'Unknown' }}</span>
                </div>
            </div>
        </div>
        
        <div class="ticket-comments">
            <h3>Comments</h3>
            <div id="commentsContainer" class="comments-container">
                <!-- Comments will be loaded here -->
            </div>
            
            <div class="comment-form">
                <h4>Add Comment</h4>
                <textarea id="commentText" rows="4" placeholder="Enter your comment..."></textarea>
                <button onclick="addComment({{ ticket.ticket_id }})" class="btn-primary">Post Comment</button>
            </div>
        </div>
    </div>
</div>

<script>
let allUsers = [];

document.addEventListener('DOMContentLoaded', function() {
    loadUsers();
    loadComments({{ ticket.ticket_id }});
});

function loadUsers() {
    fetch('/tickets/api/users')
        .then(response => response.json())
        .then(users => {
            allUsers = users;
            const select = document.getElementById('assignedSelect');
            const currentAssigned = {{ ticket.assigned_user_id if ticket.assigned_user_id else 'null' }};
            
            users.forEach(user => {
                const option = document.createElement('option');
                option.value = user.user_id;
                option.textContent = user.name || user.email;
                if (user.user_id === currentAssigned) {
                    option.selected = true;
                }
                select.appendChild(option);
            });
        })
        .catch(error => console.error('Error loading users:', error));
}

function loadComments(ticketId) {
    fetch(`/tickets/api/tickets/${ticketId}/comments`, {
        method: 'GET'
    })
        .then(response => response.json())
        .then(comments => {
            const container = document.getElementById('commentsContainer');
            container.innerHTML = '';
            
            if (comments.length === 0) {
                container.innerHTML = '<p class="no-comments">No comments yet.</p>';
                return;
            }
            
            comments.forEach(comment => {
                const commentDiv = createCommentElement(comment);
                container.appendChild(commentDiv);
            });
        })
        .catch(error => {
            console.error('Error loading comments:', error);
            document.getElementById('commentsContainer').innerHTML = 
                '<p class="error">Error loading comments.</p>';
        });
}

function createCommentElement(comment) {
    const div = document.createElement('div');
    div.className = 'comment-item';
    
    const userName = comment.user_name || comment.user?.name || comment.user_email || comment.user?.email || 'Unknown';
    const userPicture = comment.user_picture_url || comment.user?.picture_url;
    const date = new Date(comment.created_at);
    
    div.innerHTML = `
        <div class="comment-header">
            <div class="comment-author">
                ${userPicture ? `<img src="${escapeHtml(userPicture)}" alt="${escapeHtml(userName)}" class="comment-avatar">` : ''}
                <span class="comment-author-name">${escapeHtml(userName)}</span>
            </div>
            <span class="comment-date">${formatDate(date)}</span>
        </div>
        <div class="comment-text">${escapeHtml(comment.comment_text)}</div>
    `;
    
    return div;
}

function addComment(ticketId) {
    const text = document.getElementById('commentText').value.trim();
    if (!text) {
        alert('Please enter a comment');
        return;
    }
    
    fetch(`/tickets/api/tickets/${ticketId}/comments`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            comment_text: text
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            alert('Error: ' + data.error);
            return;
        }
        
        document.getElementById('commentText').value = '';
        loadComments(ticketId);
    })
    .catch(error => {
        console.error('Error adding comment:', error);
        alert('Error adding comment');
    });
}

function updateStatus(ticketId) {
    const status = document.getElementById('statusSelect').value;
    updateTicket(ticketId, { status: status });
}

function updatePriority(ticketId) {
    const priority = document.getElementById('prioritySelect').value;
    updateTicket(ticketId, { priority: priority });
}

function updateCategory(ticketId) {
    const category = document.getElementById('categorySelect').value;
    updateTicket(ticketId, { category: category });
}

function updateAssignment(ticketId) {
    const assignedId = document.getElementById('assignedSelect').value;
    updateTicket(ticketId, { assigned_user_id: assignedId ? parseInt(assignedId) : null });
}

function updateDueDate(ticketId) {
    const dueDate = document.getElementById('dueDateInput').value;
    updateTicket(ticketId, { due_date: dueDate || null });
}

function updateTicket(ticketId, data) {
    fetch(`/tickets/api/tickets/${ticketId}`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        if (result.error) {
            alert('Error: ' + result.error);
            location.reload();
        }
    })
    .catch(error => {
        console.error('Error updating ticket:', error);
        alert('Error updating ticket');
        location.reload();
    });
}

function deleteTicket(ticketId) {
    if (!confirm('Are you sure you want to delete this ticket? This action cannot be undone.')) {
        return;
    }
    
    fetch(`/tickets/api/tickets/${ticketId}`, {
        method: 'DELETE'
    })
    .then(response => response.json())
    .then(result => {
        if (result.error) {
            alert('Error: ' + result.error);
        } else {
            window.location.href = '/tickets/';
        }
    })
    .catch(error => {
        console.error('Error deleting ticket:', error);
        alert('Error deleting ticket');
    });
}

function formatDate(date) {
    return new Date(date).toLocaleString('en-US', {
        year: 'numeric',
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });
}

function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}
</script>
{% endblock %}
