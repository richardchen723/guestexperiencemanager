{% extends "base.html" %}

{% block title %}Ticket #{{ ticket.ticket_id }} - Hostaway Insights Dashboard{% endblock %}

{% block content %}
<div class="ticket-detail-page">
    <div class="ticket-detail-header">
        <div>
            <h2>Ticket #{{ ticket.ticket_id }}: {{ ticket.title }}</h2>
            <div class="ticket-badges">
                <span class="status-badge status-{{ ticket.status.lower().replace(' ', '-') }}">{{ ticket.status }}</span>
                <span class="priority-badge priority-{{ ticket.priority.lower() }}">{{ ticket.priority }}</span>
                {% if ticket.category %}
                <span class="category-badge category-{{ ticket.category }}">{{ ticket.category|title }}</span>
                {% else %}
                <span class="category-badge category-other">Other</span>
                {% endif %}
            </div>
        </div>
        <div class="ticket-actions">
            {% if current_user.user_id == ticket.created_by or current_user.user_id == ticket.assigned_user_id or current_user.is_admin() %}
            <a href="{{ url_for('tickets.ticket_edit_form', ticket_id=ticket.ticket_id) }}" class="btn-secondary">Edit</a>
            {% endif %}
            {% if current_user.is_admin() %}
            <button onclick="deleteTicket({{ ticket.ticket_id }})" class="btn-danger">Delete</button>
            {% endif %}
        </div>
    </div>
    
    <div class="ticket-detail-content">
        <div class="ticket-info">
            <div class="info-section">
                <h3>Details</h3>
                <div class="info-row">
                    <label>Issue:</label>
                    <span>{{ ticket.issue_title }}</span>
                </div>
                <div class="info-row">
                    <label>Property:</label>
                    <span>
                        {% if ticket.listing_id %}
                            {% if listing %}
                            <a href="/insights/{{ listing.listing_id }}">{{ listing.name }}</a>
                            {% else %}
                            Listing #{{ ticket.listing_id }}
                            {% endif %}
                        {% else %}
                        General (No specific property)
                        {% endif %}
                    </span>
                </div>
                <div class="info-row">
                    <label>Description:</label>
                    <span>{{ ticket.description or 'No description' }}</span>
                </div>
                <div class="info-row">
                    <label>Status:</label>
                    <select id="statusSelect" onchange="updateStatus({{ ticket.ticket_id }})">
                        <option value="Open" {% if ticket.status == 'Open' %}selected{% endif %}>Open</option>
                        <option value="Assigned" {% if ticket.status == 'Assigned' %}selected{% endif %}>Assigned</option>
                        <option value="In Progress" {% if ticket.status == 'In Progress' %}selected{% endif %}>In Progress</option>
                        <option value="Blocked" {% if ticket.status == 'Blocked' %}selected{% endif %}>Blocked</option>
                        <option value="Resolved" {% if ticket.status == 'Resolved' %}selected{% endif %}>Resolved</option>
                        <option value="Closed" {% if ticket.status == 'Closed' %}selected{% endif %}>Closed</option>
                    </select>
                </div>
                <div class="info-row">
                    <label>Priority:</label>
                    <select id="prioritySelect" onchange="updatePriority({{ ticket.ticket_id }})">
                        <option value="Low" {% if ticket.priority == 'Low' %}selected{% endif %}>Low</option>
                        <option value="Medium" {% if ticket.priority == 'Medium' %}selected{% endif %}>Medium</option>
                        <option value="High" {% if ticket.priority == 'High' %}selected{% endif %}>High</option>
                        <option value="Critical" {% if ticket.priority == 'Critical' %}selected{% endif %}>Critical</option>
                    </select>
                </div>
                <div class="info-row">
                    <label>Category:</label>
                    <select id="categorySelect" onchange="updateCategory({{ ticket.ticket_id }})">
                        <option value="other" {% if not ticket.category or ticket.category == 'other' %}selected{% endif %}>Other</option>
                        <option value="cleaning" {% if ticket.category == 'cleaning' %}selected{% endif %}>Cleaning</option>
                        <option value="maintenance" {% if ticket.category == 'maintenance' %}selected{% endif %}>Maintenance</option>
                        <option value="online" {% if ticket.category == 'online' %}selected{% endif %}>Online</option>
                    </select>
                </div>
                <div class="info-row">
                    <label>Assigned To:</label>
                    <select id="assignedSelect" onchange="updateAssignment({{ ticket.ticket_id }})">
                        <option value="">Unassigned</option>
                    </select>
                </div>
                <div class="info-row">
                    <label>Due Date:</label>
                    <input type="date" id="dueDateInput" value="{{ ticket.due_date.strftime('%Y-%m-%d') if ticket.due_date else '' }}" onchange="updateDueDate({{ ticket.ticket_id }})">
                </div>
                <div class="info-row">
                    <label>Created:</label>
                    <span>{{ ticket.created_at.strftime('%Y-%m-%d %H:%M') if ticket.created_at else '' }}</span>
                </div>
                <div class="info-row">
                    <label>Created By:</label>
                    <span>{{ ticket.creator.name if ticket.creator else 'Unknown' }}</span>
                </div>
                <div class="info-row">
                    <label>Tags:</label>
                    <div id="ticketTagsDisplay" class="tags-display"></div>
                    <div id="ticketTagInputContainer" style="margin-top: 0.5rem;"></div>
                </div>
                
                <div class="info-row">
                    <label>Images:</label>
                    <div id="ticketImagesContainer"></div>
                </div>
            </div>
        </div>
        
        <div class="ticket-comments">
            <h3>Comments</h3>
            <div id="commentsContainer" class="comments-container">
                <!-- Comments will be loaded here -->
            </div>
            
            <div class="comment-form">
                <h4>Add Comment</h4>
                <textarea id="commentText" rows="4" placeholder="Enter your comment..."></textarea>
                <div id="commentImagesContainer" style="margin-top: 0.5rem;"></div>
                <button onclick="addComment({{ ticket.ticket_id }})" class="btn-primary">Post Comment</button>
            </div>
        </div>
    </div>
</div>

<script src="/static/js/tags.js"></script>
<script src="/static/js/ticket-images.js"></script>
<script>
let allUsers = [];
let ticketTagInput = null;
let ticketImageUploader = null;

document.addEventListener('DOMContentLoaded', function() {
    loadUsers();
    loadComments({{ ticket.ticket_id }});
    loadTicketTags({{ ticket.ticket_id }});
    initializeTicketImages({{ ticket.ticket_id }});
    initializeCommentImages();
    
    // Add file input for comment images
    const commentForm = document.querySelector('.comment-form');
    if (commentForm && commentImageUploader) {
        const fileInput = document.createElement('input');
        fileInput.type = 'file';
        fileInput.accept = 'image/*';
        fileInput.multiple = true;
        fileInput.style.display = 'none';
        fileInput.id = 'commentImageInput';
        
        fileInput.addEventListener('change', (e) => {
            const files = Array.from(e.target.files);
            files.forEach(file => {
                // Don't reject large files - backend will create thumbnail only
                commentImageUploader.images.push(file);
                
                // Show preview
                const preview = document.getElementById('commentImagesPreview');
                if (preview) {
                    const previewItem = document.createElement('div');
                    previewItem.className = 'comment-image-preview-item';
                    const img = document.createElement('img');
                    img.src = URL.createObjectURL(file);
                    img.className = 'comment-image-preview-thumb';
                    const removeBtn = document.createElement('button');
                    removeBtn.innerHTML = '×';
                    removeBtn.className = 'comment-image-preview-remove';
                    removeBtn.onclick = () => {
                        commentImageUploader.images = commentImageUploader.images.filter(f => f !== file);
                        previewItem.remove();
                    };
                    previewItem.appendChild(img);
                    previewItem.appendChild(removeBtn);
                    preview.appendChild(previewItem);
                }
            });
            fileInput.value = '';
        });
        
        const uploadBtn = document.createElement('button');
        uploadBtn.type = 'button';
        uploadBtn.className = 'btn-secondary';
        uploadBtn.textContent = 'Attach Images';
        uploadBtn.style.marginTop = '0.5rem';
        uploadBtn.onclick = () => fileInput.click();
        
        const previewContainer = document.getElementById('commentImagesPreview');
        if (previewContainer && previewContainer.parentElement) {
            previewContainer.parentElement.insertBefore(uploadBtn, previewContainer);
            previewContainer.parentElement.insertBefore(fileInput, previewContainer);
        }
    }
});

function loadUsers() {
    fetch('/tickets/api/users')
        .then(response => response.json())
        .then(users => {
            allUsers = users;
            const select = document.getElementById('assignedSelect');
            const currentAssigned = {{ ticket.assigned_user_id if ticket.assigned_user_id else 'null' }};
            
            users.forEach(user => {
                const option = document.createElement('option');
                option.value = user.user_id;
                option.textContent = user.name || user.email;
                if (user.user_id === currentAssigned) {
                    option.selected = true;
                }
                select.appendChild(option);
            });
        })
        .catch(error => console.error('Error loading users:', error));
}

function loadComments(ticketId) {
    fetch(`/tickets/api/tickets/${ticketId}/comments`, {
        method: 'GET'
    })
        .then(response => response.json())
        .then(comments => {
            console.log('Loaded comments:', comments);
            const container = document.getElementById('commentsContainer');
            container.innerHTML = '';
            
            if (comments.length === 0) {
                container.innerHTML = '<p class="no-comments">No comments yet.</p>';
                return;
            }
            
            comments.forEach(comment => {
                console.log('Processing comment:', comment.comment_id, 'images:', comment.images);
                const commentDiv = createCommentElement(comment);
                container.appendChild(commentDiv);
            });
        })
        .catch(error => {
            console.error('Error loading comments:', error);
            document.getElementById('commentsContainer').innerHTML = 
                '<p class="error">Error loading comments.</p>';
        });
}

function createCommentElement(comment) {
    const div = document.createElement('div');
    div.className = 'comment-item';
    
    const userName = comment.user_name || comment.user?.name || comment.user_email || comment.user?.email || 'Unknown';
    const userPicture = comment.user_picture_url || comment.user?.picture_url;
    const date = new Date(comment.created_at);
    
    // Build images HTML
    let imagesHtml = '';
    if (comment.images && Array.isArray(comment.images) && comment.images.length > 0) {
        console.log(`Rendering ${comment.images.length} images for comment ${comment.comment_id}`);
        imagesHtml = '<div class="comment-images">';
        comment.images.forEach(img => {
            console.log('Comment image:', img);
            imagesHtml += `
                <div class="comment-image-item">
                    <img src="/tickets/api/images/${img.image_id}/thumbnail" 
                         alt="${escapeHtml(img.file_name || 'Image')}"
                         onclick="showImageLightbox(${img.image_id})"
                         class="comment-image-thumb"
                         onerror="console.error('Failed to load image ${img.image_id}'); this.style.display='none';">
                </div>
            `;
        });
        imagesHtml += '</div>';
    } else {
        console.log(`No images for comment ${comment.comment_id}, images:`, comment.images);
    }
    
    div.innerHTML = `
        <div class="comment-header">
            <div class="comment-author">
                ${userPicture ? `<img src="${escapeHtml(userPicture)}" alt="${escapeHtml(userName)}" class="comment-avatar">` : ''}
                <span class="comment-author-name">${escapeHtml(userName)}</span>
            </div>
            <span class="comment-date">${formatDate(date)}</span>
        </div>
        <div class="comment-text">${escapeHtml(comment.comment_text)}</div>
        ${imagesHtml}
    `;
    
    return div;
}

function showImageLightbox(imageId) {
    const lightbox = document.createElement('div');
    lightbox.className = 'image-lightbox';
    lightbox.innerHTML = `
        <div class="lightbox-content">
            <button class="lightbox-close">×</button>
            <img src="/tickets/api/images/${imageId}" alt="Image">
        </div>
    `;
    
    document.body.appendChild(lightbox);
    
    const close = () => {
        lightbox.remove();
    };
    
    lightbox.querySelector('.lightbox-close').addEventListener('click', close);
    lightbox.addEventListener('click', (e) => {
        if (e.target === lightbox) close();
    });
    
    document.addEventListener('keydown', function escHandler(e) {
        if (e.key === 'Escape') {
            close();
            document.removeEventListener('keydown', escHandler);
        }
    });
}

let commentImageUploader = null;

function initializeCommentImages() {
    const container = document.getElementById('commentImagesContainer');
    if (!container) return;
    
    commentImageUploader = {
        images: [],
        container: container
    };
    
    container.innerHTML = '<div id="commentImagesPreview" class="comment-images-preview"></div>';
}

function addComment(ticketId) {
    const text = document.getElementById('commentText').value.trim();
    const images = commentImageUploader ? commentImageUploader.images : [];
    
    if (!text && images.length === 0) {
        alert('Please enter a comment or attach an image');
        return;
    }
    
    // First create the comment
    fetch(`/tickets/api/tickets/${ticketId}/comments`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            comment_text: text || '(No text)'
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            alert('Error: ' + data.error);
            return;
        }
        
        const commentId = data.comment_id;
        
        // Upload images if any
        if (images.length > 0) {
            const uploadPromises = images.map(file => {
                const formData = new FormData();
                formData.append('image', file);
                return fetch(`/tickets/api/comments/${commentId}/images`, {
                    method: 'POST',
                    body: formData
                }).then(response => {
                    if (!response.ok) {
                        return response.json().then(err => Promise.reject(new Error(err.error || 'Upload failed')));
                    }
                    return response.json();
                });
            });
            
            Promise.all(uploadPromises).then((uploadResults) => {
                console.log('All images uploaded successfully:', uploadResults);
                document.getElementById('commentText').value = '';
                if (commentImageUploader) {
                    commentImageUploader.images = [];
                    const preview = document.getElementById('commentImagesPreview');
                    if (preview) preview.innerHTML = '';
                }
                // Small delay to ensure database commit
                setTimeout(() => {
                    loadComments(ticketId);
                }, 100);
            }).catch(error => {
                console.error('Error uploading comment images:', error);
                alert(`Error uploading images: ${error.message}`);
                document.getElementById('commentText').value = '';
                if (commentImageUploader) {
                    commentImageUploader.images = [];
                    const preview = document.getElementById('commentImagesPreview');
                    if (preview) preview.innerHTML = '';
                }
                // Still reload comments even if image upload fails
                setTimeout(() => {
                    loadComments(ticketId);
                }, 100);
            });
        } else {
        document.getElementById('commentText').value = '';
        loadComments(ticketId);
        }
    })
    .catch(error => {
        console.error('Error adding comment:', error);
        alert('Error adding comment');
    });
}


function updateStatus(ticketId) {
    const status = document.getElementById('statusSelect').value;
    updateTicket(ticketId, { status: status });
}

function updatePriority(ticketId) {
    const priority = document.getElementById('prioritySelect').value;
    updateTicket(ticketId, { priority: priority });
}

function updateCategory(ticketId) {
    const category = document.getElementById('categorySelect').value;
    updateTicket(ticketId, { category: category });
}

function updateAssignment(ticketId) {
    const assignedId = document.getElementById('assignedSelect').value;
    updateTicket(ticketId, { assigned_user_id: assignedId ? parseInt(assignedId) : null });
}

function updateDueDate(ticketId) {
    const dueDate = document.getElementById('dueDateInput').value;
    updateTicket(ticketId, { due_date: dueDate || null });
}

function updateTicket(ticketId, data) {
    fetch(`/tickets/api/tickets/${ticketId}`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        if (result.error) {
            alert('Error: ' + result.error);
            location.reload();
        }
    })
    .catch(error => {
        console.error('Error updating ticket:', error);
        alert('Error updating ticket');
        location.reload();
    });
}

function deleteTicket(ticketId) {
    if (!confirm('Are you sure you want to delete this ticket? This action cannot be undone.')) {
        return;
    }
    
    fetch(`/tickets/api/tickets/${ticketId}`, {
        method: 'DELETE'
    })
    .then(response => response.json())
    .then(result => {
        if (result.error) {
            alert('Error: ' + result.error);
        } else {
            window.location.href = '/tickets/';
        }
    })
    .catch(error => {
        console.error('Error deleting ticket:', error);
        alert('Error deleting ticket');
    });
}

function formatDate(date) {
    return new Date(date).toLocaleString('en-US', {
        year: 'numeric',
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });
}

function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function loadTicketTags(ticketId) {
    fetch(`/tickets/api/tickets/${ticketId}/tags`)
        .then(response => response.json())
        .then(tags => {
            const displayContainer = document.getElementById('ticketTagsDisplay');
            renderTags(displayContainer, tags, {
                showInherited: true,
                onRemove: (tag, index) => {
                    if (!tag.is_inherited) {
                        removeTicketTag(ticketId, tag.tag_id);
                    }
                }
            });
            
            // Initialize tag input for adding new tags
            if (!ticketTagInput) {
                const inputContainer = document.getElementById('ticketTagInputContainer');
                ticketTagInput = new TagInput(inputContainer, {
                    existingTags: tags.filter(t => !t.is_inherited),
                    onTagsChange: (newTags) => {
                        // Only add tags that aren't already in the list
                        const currentTagIds = tags.map(t => t.tag_id);
                        const tagsToAdd = newTags.filter(t => !currentTagIds.includes(t.tag_id));
                        if (tagsToAdd.length > 0) {
                            addTicketTags(ticketId, tagsToAdd.map(t => t.name));
                        }
                    }
                });
            }
        })
        .catch(error => {
            console.error('Error loading ticket tags:', error);
        });
}

function addTicketTags(ticketId, tagNames) {
    fetch(`/tickets/api/tickets/${ticketId}/tags`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ tags: tagNames })
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            alert('Error: ' + data.error);
        } else {
            loadTicketTags(ticketId);
        }
    })
    .catch(error => {
        console.error('Error adding tags:', error);
        alert('Error adding tags');
    });
}

function removeTicketTag(ticketId, tagId) {
    fetch(`/tickets/api/tickets/${ticketId}/tags/${tagId}`, {
        method: 'DELETE'
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            alert('Error: ' + data.error);
        } else {
            loadTicketTags(ticketId);
        }
    })
    .catch(error => {
        console.error('Error removing tag:', error);
        alert('Error removing tag');
    });
}

function initializeTicketImages(ticketId) {
    const container = document.getElementById('ticketImagesContainer');
    if (!container) {
        console.error('ticketImagesContainer not found');
        return;
    }
    
    try {
        ticketImageUploader = new ImageUploader(container, {
            uploadEndpoint: `/tickets/api/tickets/${ticketId}/images`,
            deleteEndpoint: `/tickets/api/tickets/${ticketId}/images`,
            listEndpoint: `/tickets/api/tickets/${ticketId}/images`,
            imageServeUrl: '/tickets/api/images',
            thumbnailUrl: '/tickets/api/images',
            maxFiles: 10,
            maxFileSize: 2 * 1024 * 1024,
            onUploadComplete: (imageData) => {
                console.log('Image uploaded successfully:', imageData);
                // Image is already added to gallery by ImageUploader
            },
            onDeleteComplete: (imageId) => {
                console.log('Image deleted successfully:', imageId);
                // Image is already removed from gallery by ImageUploader
            }
        });
        console.log('ImageUploader initialized for ticket', ticketId);
    } catch (error) {
        console.error('Error initializing ImageUploader:', error);
    }
}
</script>
{% endblock %}
