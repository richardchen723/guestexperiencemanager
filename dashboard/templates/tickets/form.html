{% extends "base.html" %}

{% block title %}{% if ticket %}Edit Ticket{% else %}Create Ticket{% endif %} - Hostaway Insights Dashboard{% endblock %}

{% block content %}
<div class="ticket-form-page">
    <div class="page-header">
        <div>
            <h1 class="page-title">{% if ticket %}Edit Ticket{% else %}Create New Ticket{% endif %}</h1>
            <p class="page-description">{% if ticket %}Update ticket details and status{% else %}Create a new action item ticket from a property issue{% endif %}</p>
        </div>
    </div>
    
    <div class="card">
        <form id="ticketForm" onsubmit="saveTicket(event)" class="ticket-form">
            <div class="form-group">
                <label for="listingMultiSelect" class="form-label">Properties</label>
                <div id="listingMultiSelect" class="listing-multiselect-container"></div>
                <small style="color: var(--text-tertiary); font-size: var(--text-sm); margin-top: var(--space-1); display: block;">
                    Select one or more properties. Leave empty for general tickets.
                </small>
            </div>
            
            <div class="form-group">
                <label for="ticketTagsInput" class="form-label">Tags</label>
                <div id="ticketTagsInput" class="tag-input-container"></div>
                <small style="color: var(--text-tertiary); font-size: var(--text-sm); margin-top: var(--space-1); display: block;">
                    Tags inherited from property will be added automatically. You can add more tags here.
                </small>
            </div>
            
            <div class="form-group">
                <label for="issueSelect" class="form-label">Issue <span id="issueRequired" style="color: var(--text-tertiary);">*</span></label>
                <div style="display: flex; gap: var(--space-3); align-items: flex-start;">
                    <div style="flex: 1;">
                        <select id="issueSelect" class="form-select">
                            <option value="">Select an issue</option>
                        </select>
                        <input type="text" id="issueTitleInput" class="form-input" placeholder="Or enter issue title manually" style="display: none; margin-top: var(--space-2);">
                    </div>
                </div>
                <button type="button" onclick="toggleIssueInput()" class="btn btn-link btn-sm" style="margin-top: var(--space-2);">Enter manually</button>
            </div>
            
            <div class="form-group">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-2);">
                    <label for="titleInput" class="form-label" style="margin: 0;">Ticket Title *</label>
                    <button type="button" id="aiSuggestionsBtn" class="btn btn-secondary btn-sm">
                        <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" style="margin-right: var(--space-1);">
                            <path d="M8 2.66667V5.33333M8 2.66667C5.42267 2.66667 3.33333 4.756 3.33333 7.33333M8 2.66667L5.33333 0M8 10.6667V13.3333M8 13.3333C10.5773 13.3333 12.6667 11.244 12.6667 8.66667M8 13.3333L10.6667 16" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        Get AI Suggestions
                    </button>
                </div>
                <input type="text" id="titleInput" class="form-input" required placeholder="Enter a specific, actionable title">
            </div>
            
            <div class="form-group">
                <label for="descriptionInput" class="form-label">Description</label>
                <textarea id="descriptionInput" class="form-textarea" rows="5" placeholder="Enter detailed description of the action item"></textarea>
            </div>
            
            <div class="form-group">
                <label class="form-label">Images</label>
                <div id="ticketFormImagesContainer"></div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="statusSelect" class="form-label">Status</label>
                    <select id="statusSelect" class="form-select">
                        <option value="Open">Open</option>
                        <option value="Assigned">Assigned</option>
                        <option value="In Progress">In Progress</option>
                        <option value="Blocked">Blocked</option>
                        <option value="Resolved">Resolved</option>
                        <option value="Closed">Closed</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="prioritySelect" class="form-label">Priority</label>
                    <select id="prioritySelect" class="form-select">
                        <option value="Low">Low</option>
                        <option value="Medium">Medium</option>
                        <option value="High">High</option>
                        <option value="Critical">Critical</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="categorySelect" class="form-label">Category *</label>
                    <select id="categorySelect" class="form-select" required>
                        <option value="other">Other</option>
                        <option value="cleaning">Cleaning</option>
                        <option value="maintenance">Maintenance</option>
                        <option value="online">Online</option>
                        <option value="technology">Technology</option>
                        <option value="review management">Review Management</option>
                    </select>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="assignedSelect" class="form-label">Assign To</label>
                    <select id="assignedSelect" class="form-select">
                        <option value="">Unassigned</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="dueDateInput" class="form-label">Due Date</label>
                    <input type="date" id="dueDateInput" class="form-input">
                </div>
            </div>
            
            <div class="form-group">
                <label class="form-label">
                    <input type="checkbox" id="isRecurringCheckbox" onchange="toggleRecurringFields()">
                    Make this a recurring task
                </label>
                <div id="recurringFieldsContainer" style="display: none; margin-top: var(--space-3); padding: var(--space-4); background: var(--bg-secondary); border-radius: var(--radius-md);">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="frequencyValueInput" class="form-label">Frequency</label>
                            <div style="display: flex; gap: var(--space-2); align-items: center;">
                                <input type="number" id="frequencyValueInput" class="form-input" min="1" placeholder="30" style="width: 100px;">
                                <select id="frequencyUnitSelect" class="form-select" style="flex: 1;">
                                    <option value="days">Days</option>
                                    <option value="months">Months</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="reopenDaysInput" class="form-label">Reopen Days Before Due Date</label>
                            <input type="number" id="reopenDaysInput" class="form-input" min="0" value="10" placeholder="10">
                            <small style="color: var(--text-tertiary); font-size: var(--text-sm);">Number of days before due date to automatically reopen</small>
                        </div>
                    </div>
                    {% if ticket and ticket.is_recurring %}
                    <div class="form-group" style="margin-top: var(--space-3);">
                        <label>
                            <input type="checkbox" id="isRecurringActiveCheckbox" {% if ticket.is_recurring_active %}checked{% endif %}>
                            Recurring is active
                        </label>
                    </div>
                    {% endif %}
                </div>
            </div>
            
            <div class="form-actions">
                <button type="submit" class="btn btn-primary">{% if ticket %}Update Ticket{% else %}Create Ticket{% endif %}</button>
                <a href="{% if ticket %}/tickets/{{ ticket.ticket_id }}/page{% else %}/tickets/{% endif %}" class="btn btn-secondary">Cancel</a>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block modals %}
<!-- AI Suggestions Modal - Placed outside content-wrapper to avoid container constraints -->
<div id="suggestionsModal" class="modal-backdrop" style="display: none !important; z-index: 99999 !important;">
    <div class="modal" style="display: block !important;">
        <div class="modal-header">
            <h3 class="modal-title">AI Suggestions</h3>
            <button onclick="closeSuggestionsModal()" class="modal-close">&times;</button>
        </div>
        <div class="modal-body">
            <div id="suggestionsLoading" class="loading">
                <div class="spinner"></div>
                <span>Generating AI suggestions...</span>
            </div>
            <div id="suggestionsContent" style="display: none;">
                <div class="form-group">
                    <label for="suggestedTitle" class="form-label">Title</label>
                    <input type="text" id="suggestedTitle" class="form-input">
                </div>
                <div class="form-group">
                    <label for="suggestedDescription" class="form-label">Description</label>
                    <textarea id="suggestedDescription" class="form-textarea" rows="4"></textarea>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="suggestedPriority" class="form-label">Priority</label>
                        <select id="suggestedPriority" class="form-select">
                            <option value="Low">Low</option>
                            <option value="Medium">Medium</option>
                            <option value="High">High</option>
                            <option value="Critical">Critical</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="suggestedCategory" class="form-label">Category</label>
                        <select id="suggestedCategory" class="form-select">
                            <option value="other">Other</option>
                            <option value="cleaning">Cleaning</option>
                            <option value="maintenance">Maintenance</option>
                            <option value="online">Online</option>
                            <option value="technology">Technology</option>
                            <option value="review management">Review Management</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="suggestedDueDate" class="form-label">Due Date</label>
                        <input type="date" id="suggestedDueDate" class="form-input">
                    </div>
                </div>
            </div>
            <div id="suggestionsError" class="alert alert-error" style="display: none;"></div>
        </div>
        <div class="modal-footer">
            <button onclick="saveSuggestions()" class="btn btn-primary">Save Suggestions</button>
            <button onclick="closeSuggestionsModal()" class="btn btn-secondary">Close</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="/static/js/tags.js"></script>
<script src="/static/js/ticket-images.js"></script>
<script src="/static/js/mention-handler.js"></script>
<script src="/static/js/listing-multiselect.js"></script>
<script>
let allListings = [];
let allUsers = [];
let allIssues = [];
let currentListingId = null;
let ticketId = {% if ticket %}{{ ticket.ticket_id }}{% else %}null{% endif %};
let ticketFormImageUploader = null;
let pendingImages = []; // For new tickets - images to upload after ticket creation
let ticketTagInput = null; // TagInput instance for ticket tags
let listingMultiSelect = null; // ListingMultiSelect instance

document.addEventListener('DOMContentLoaded', function() {
    loadListings();
    loadUsers();
    
    // Initialize image uploader
    initializeTicketFormImages();
    
    // Initialize tag input
    initializeTicketTags();
    
    // Attach event listener to AI Suggestions button
    const aiBtn = document.getElementById('aiSuggestionsBtn');
    if (aiBtn) {
        aiBtn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            console.log('AI Suggestions button clicked via event listener');
            getAISuggestions(e);
            return false;
        });
        console.log('âœ“ AI Suggestions button event listener attached');
    } else {
        console.error('âŒ AI Suggestions button not found!');
    }
    
    // Also add a test function to window for debugging
    window.testShowModal = function() {
        console.log('=== TEST: Forcing modal to show ===');
        const modal = document.getElementById('suggestionsModal');
        if (!modal) {
            alert('Modal not found!');
            return;
        }
        modal.removeAttribute('style');
        modal.style.cssText = 'display: flex !important; position: fixed !important; top: 0 !important; left: 0 !important; right: 0 !important; bottom: 0 !important; z-index: 99999 !important; background: rgba(255, 0, 0, 0.8) !important; align-items: center !important; justify-content: center !important;';
        alert('Modal should be visible now with red background. Check the page!');
    };
    
    {% if ticket %}
    // Edit mode - populate form
    populateEditForm();
    {% elif listing_id %}
    // Pre-fill listing and issue
    // Pre-select listing in multi-select if provided
    if (listingMultiSelect && {{ listing_id }}) {
        listingMultiSelect.setSelectedListingIds([{{ listing_id }}]);
    loadIssues();
    }
    {% if issue_title %}
    if ({{ issue_title|tojson }}) {
        setTimeout(() => {
            document.getElementById('issueSelect').value = {{ issue_title|tojson }};
        }, 500);
    }
    {% endif %}
    {% endif %}
});

function loadListings() {
    fetch('/api/listings')
        .then(response => response.json())
        .then(listings => {
            allListings = listings;
            
            // Initialize multi-select component
            const container = document.getElementById('listingMultiSelect');
            if (container) {
                let selectedListingIds = [];
                {% if ticket %}
                // Edit mode - get selected listings from ticket
                // First try to get from API (which includes listing_ids from TicketListing)
                fetch(`/tickets/api/tickets/${ticketId}`)
                    .then(response => response.json())
                    .then(ticketData => {
                        if (ticketData.listing_ids && ticketData.listing_ids.length > 0) {
                            selectedListingIds = ticketData.listing_ids;
                        } else if ({{ ticket.listing_id }}) {
                            // Fallback to old listing_id
                            selectedListingIds = [{{ ticket.listing_id }}];
                        }
                        
                        if (listingMultiSelect) {
                            listingMultiSelect.setSelectedListingIds(selectedListingIds);
                        } else {
                            listingMultiSelect = new ListingMultiSelect(container, {
                                listings: listings,
                                selectedListingIds: selectedListingIds,
                                onSelectionChange: (selectedIds) => {
                                    // Update currentListingId for backward compatibility
                                    currentListingId = selectedIds.length > 0 && selectedIds[0] !== 0 ? selectedIds[0] : null;
                                    loadIssues();
                                    loadPropertyTags();
                                    updateIssueRequired();
                                },
                                placeholder: 'Select properties...',
                                allowGeneral: true
                            });
                        }
                        loadIssues();
                        updateIssueRequired();
                    })
                    .catch(error => {
                        console.error('Error loading ticket data:', error);
                        // Fallback to old listing_id
                        if ({{ ticket.listing_id }}) {
                            selectedListingIds = [{{ ticket.listing_id }}];
                        }
                        listingMultiSelect = new ListingMultiSelect(container, {
                            listings: listings,
                            selectedListingIds: selectedListingIds,
                            onSelectionChange: (selectedIds) => {
                                currentListingId = selectedIds.length > 0 && selectedIds[0] !== 0 ? selectedIds[0] : null;
                                loadIssues();
                                loadPropertyTags();
                                updateIssueRequired();
                            },
                            placeholder: 'Select properties...',
                            allowGeneral: true
                        });
            loadIssues();
                        updateIssueRequired();
                    });
                {% elif listing_id %}
                // Pre-fill with provided listing_id
                selectedListingIds = [{{ listing_id }}];
                listingMultiSelect = new ListingMultiSelect(container, {
                    listings: listings,
                    selectedListingIds: selectedListingIds,
                    onSelectionChange: (selectedIds) => {
                        // Update currentListingId for backward compatibility
                        currentListingId = selectedIds.length > 0 && selectedIds[0] !== 0 ? selectedIds[0] : null;
                        loadIssues();
                        loadPropertyTags();
                        updateIssueRequired();
                    },
                    placeholder: 'Select properties...',
                    allowGeneral: true
                });
                loadIssues();
                updateIssueRequired();
                {% else %}
                // Create mode - no pre-selection
                listingMultiSelect = new ListingMultiSelect(container, {
                    listings: listings,
                    selectedListingIds: [],
                    onSelectionChange: (selectedIds) => {
                        // Update currentListingId for backward compatibility
                        currentListingId = selectedIds.length > 0 && selectedIds[0] !== 0 ? selectedIds[0] : null;
                        loadIssues();
                        loadPropertyTags();
                        updateIssueRequired();
                    },
                    placeholder: 'Select properties...',
                    allowGeneral: true
                });
                updateIssueRequired();
            {% endif %}
            }
        })
        .catch(error => console.error('Error loading listings:', error));
}

function loadUsers() {
    fetch('/tickets/api/users')
        .then(response => response.json())
        .then(users => {
            allUsers = users;
            const select = document.getElementById('assignedSelect');
            users.forEach(user => {
                const option = document.createElement('option');
                option.value = user.user_id;
                option.textContent = user.name || user.email;
                {% if ticket and ticket.assigned_user_id %}
                if (user.user_id === {{ ticket.assigned_user_id }}) {
                    option.selected = true;
                }
                {% endif %}
                select.appendChild(option);
            });
        })
        .catch(error => console.error('Error loading users:', error));
}

function loadIssues() {
    // Get selected listing IDs from multi-select
    const selectedListingIds = listingMultiSelect ? listingMultiSelect.getSelectedListingIds() : [];
    const firstListingId = selectedListingIds.length > 0 && selectedListingIds[0] !== 0 ? selectedListingIds[0] : null;
    
    // For backward compatibility, use first selected listing or currentListingId
    const listingId = firstListingId || currentListingId;
    currentListingId = listingId;
    
    if (!listingId || listingId === 0) {
        // For general tickets or no selection, clear issues dropdown
        document.getElementById('issueSelect').innerHTML = '<option value="">Select an issue</option>';
        updateIssueRequired();
        return;
    }
    
    fetch(`/tickets/api/listings/${listingId}/issues`)
        .then(response => response.json())
        .then(data => {
            allIssues = data.issues || [];
            const select = document.getElementById('issueSelect');
            select.innerHTML = '<option value="">Select an issue</option>';
            
            allIssues.forEach(issue => {
                const option = document.createElement('option');
                option.value = issue.title;
                option.textContent = issue.title;
                {% if ticket %}
                if (issue.title === {{ ticket.issue_title|tojson }}) {
                    option.selected = true;
                }
                {% elif issue_title %}
                if (issue.title === {{ issue_title|tojson }}) {
                    option.selected = true;
                }
                {% endif %}
                select.appendChild(option);
            });
            updateIssueRequired(); // Update required state after loading issues
        })
        .catch(error => {
            console.error('Error loading issues:', error);
            document.getElementById('issueSelect').innerHTML = '<option value="">Error loading issues</option>';
            updateIssueRequired();
        });
}

function toggleIssueInput() {
    const select = document.getElementById('issueSelect');
    const input = document.getElementById('issueTitleInput');
    
    // Get selected listing IDs from multi-select
    const selectedListingIds = listingMultiSelect ? listingMultiSelect.getSelectedListingIds() : [];
    const validListingIds = selectedListingIds.filter(id => id !== 0); // Exclude "General"
    const hasListings = validListingIds.length > 0;
    const isRequired = hasListings; // Only required if property is selected
    
    if (input.style.display === 'none') {
        // Switch to manual input
        input.style.display = 'block';
        select.style.display = 'none';
        select.removeAttribute('required');
        if (isRequired) {
            input.setAttribute('required', 'required');
    } else {
            input.removeAttribute('required');
        }
    } else {
        // Switch back to dropdown
        input.style.display = 'none';
        select.style.display = 'block';
        input.removeAttribute('required');
        if (isRequired) {
            select.setAttribute('required', 'required');
        } else {
            select.removeAttribute('required');
        }
    }
}

function updateIssueRequired() {
    // Get selected listing IDs from multi-select
    const selectedListingIds = listingMultiSelect ? listingMultiSelect.getSelectedListingIds() : [];
    const hasListings = selectedListingIds.length > 0 && !selectedListingIds.includes(0);
    const isRequired = hasListings;
    
    const select = document.getElementById('issueSelect');
    const input = document.getElementById('issueTitleInput');
    const requiredSpan = document.getElementById('issueRequired');
    
    if (isRequired) {
        requiredSpan.style.display = 'inline';
        if (select.style.display !== 'none') {
            select.setAttribute('required', 'required');
        } else {
            input.setAttribute('required', 'required');
        }
    } else {
        requiredSpan.style.display = 'none';
        select.removeAttribute('required');
        input.removeAttribute('required');
    }
}

function getAISuggestions(event) {
    try {
        // Prevent any default behavior
        if (event) {
            event.preventDefault();
            event.stopPropagation();
        }
        
        console.log('=== getAISuggestions called ===');
        console.log('Event:', event);
        
        // First, show the modal immediately (before validation)
        const modal = document.getElementById('suggestionsModal');
        if (!modal) {
            console.error('âŒ Modal element not found in DOM');
            alert('Error: Modal element not found. Please refresh the page.');
            return false;
        }
        
        console.log('âœ“ Modal element found');
        console.log('Modal before:', {
            display: window.getComputedStyle(modal).display,
            visibility: window.getComputedStyle(modal).visibility,
            zIndex: window.getComputedStyle(modal).zIndex,
            position: window.getComputedStyle(modal).position,
            inlineStyle: modal.getAttribute('style')
        });
        
        // Show modal FIRST, before any validation - use multiple methods to ensure it shows
        console.log('Showing modal immediately...');
        
        // Method 1: Remove style attribute completely
        modal.removeAttribute('style');
        
        // Method 2: Set all styles with !important using cssText for atomic update
        const modalStyles = [
            'display: flex !important',
            'position: fixed !important',
            'top: 0 !important',
            'left: 0 !important',
            'right: 0 !important',
            'bottom: 0 !important',
            'z-index: 99999 !important',
            'background: rgba(0, 0, 0, 0.5) !important',
            'backdrop-filter: blur(4px) !important',
            'align-items: center !important',
            'justify-content: center !important',
            'padding: 1rem !important',
            'visibility: visible !important',
            'opacity: 1 !important'
        ].join('; ');
        
        modal.style.cssText = modalStyles;
        
        // Also ensure the inner .modal div is visible
        const innerModal = modal.querySelector('.modal');
        if (innerModal) {
            innerModal.style.setProperty('display', 'block', 'important');
            innerModal.style.setProperty('position', 'relative', 'important');
            innerModal.style.setProperty('z-index', '100000', 'important');
            console.log('âœ“ Inner modal styles set');
        }
        
        // Force a reflow to ensure styles are applied
        void modal.offsetHeight;
        
        // Verify the styles were applied
        const computed = window.getComputedStyle(modal);
        console.log('Modal after setting styles:', {
            display: computed.display,
            visibility: computed.visibility,
            zIndex: computed.zIndex,
            position: computed.position,
            width: computed.width,
            height: computed.height,
            top: computed.top,
            left: computed.left
        });
        
        // Check if modal is actually visible
        const rect = modal.getBoundingClientRect();
        console.log('Modal bounding rect:', rect);
        console.log('Modal visible?', rect.width > 0 && rect.height > 0);
        
        if (rect.width === 0 || rect.height === 0) {
            console.error('âŒ Modal has zero dimensions!');
            alert('Modal is not visible. Check console for details.');
        }
        
    } catch (error) {
        console.error('âŒ Error in getAISuggestions:', error);
        alert('Error: ' + error.message);
        return false;
    }
    
    // Validate inputs
    // Get selected listing IDs from multi-select
    const selectedListingIds = listingMultiSelect ? listingMultiSelect.getSelectedListingIds() : [];
    const validListingIds = selectedListingIds.filter(id => id !== 0); // Exclude "General"
    const listingId = validListingIds.length > 0 ? validListingIds[0] : null; // Use first listing for AI suggestions
    
    const issueSelect = document.getElementById('issueSelect');
    const issueInput = document.getElementById('issueTitleInput');
    
    let issueTitle = '';
    let issueDetails = '';
    
    if (issueInput && issueInput.style.display !== 'none' && issueInput.value) {
        issueTitle = issueInput.value;
    } else if (issueSelect && issueSelect.value) {
        issueTitle = issueSelect.value;
        const issue = allIssues.find(i => i.title === issueTitle);
        if (issue) {
            issueDetails = issue.details || '';
        }
    }
    
    if (!issueTitle) {
        // Show error in modal instead of hiding it
        const errorEl = document.getElementById('suggestionsError');
        const loadingEl = document.getElementById('suggestionsLoading');
        const contentEl = document.getElementById('suggestionsContent');
        
        if (loadingEl) loadingEl.style.display = 'none';
        if (contentEl) contentEl.style.display = 'none';
        if (errorEl) {
            errorEl.textContent = listingId ? 'Please select an issue first' : 'Please enter an issue title first';
            errorEl.style.display = 'block';
        }
        return false;
    }
    
    if (!listingId) {
        // AI suggestions require a property
        const errorEl = document.getElementById('suggestionsError');
        const loadingEl = document.getElementById('suggestionsLoading');
        const contentEl = document.getElementById('suggestionsContent');
        
        if (loadingEl) loadingEl.style.display = 'none';
        if (contentEl) contentEl.style.display = 'none';
        if (errorEl) {
            errorEl.textContent = 'AI suggestions are only available for property-specific tickets';
            errorEl.style.display = 'block';
        }
        return false;
    }
    
    // Show loading state
    const loadingEl = document.getElementById('suggestionsLoading');
    const contentEl = document.getElementById('suggestionsContent');
    const errorEl = document.getElementById('suggestionsError');
    
    if (loadingEl) {
        loadingEl.style.display = 'flex';
    }
    if (contentEl) {
        contentEl.style.display = 'none';
    }
    if (errorEl) {
        errorEl.style.display = 'none';
    }
    
    fetch('/tickets/api/tickets/suggest', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            listing_id: parseInt(listingId),
            issue_title: issueTitle,
            issue_details: issueDetails
        })
    })
    .then(response => response.json())
    .then(data => {
        const loading = document.getElementById('suggestionsLoading');
        const content = document.getElementById('suggestionsContent');
        const error = document.getElementById('suggestionsError');
        
        if (loading) loading.style.display = 'none';
        
        if (data.error) {
            if (error) {
                error.textContent = 'Error: ' + data.error;
                error.style.display = 'block';
            }
            return;
        }
        
        const titleInput = document.getElementById('suggestedTitle');
        const descInput = document.getElementById('suggestedDescription');
        const prioritySelect = document.getElementById('suggestedPriority');
        const categorySelect = document.getElementById('suggestedCategory');
        const dueDateInput = document.getElementById('suggestedDueDate');
        
        if (titleInput) titleInput.value = data.title || '';
        if (descInput) descInput.value = data.description || '';
        if (prioritySelect) prioritySelect.value = data.priority || 'Medium';
        if (categorySelect) categorySelect.value = data.category || 'other';
        if (dueDateInput) dueDateInput.value = data.due_date || '';
        
        if (content) content.style.display = 'block';
    })
    .catch(error => {
        const loading = document.getElementById('suggestionsLoading');
        const errorDiv = document.getElementById('suggestionsError');
        
        if (loading) loading.style.display = 'none';
        if (errorDiv) {
            errorDiv.textContent = 'Error generating suggestions: ' + error.message;
            errorDiv.style.display = 'block';
        }
    });
}

function saveSuggestions() {
    // Copy all suggested values (which may have been edited by the user) to the main form
    document.getElementById('titleInput').value = document.getElementById('suggestedTitle').value;
    document.getElementById('descriptionInput').value = document.getElementById('suggestedDescription').value;
    document.getElementById('prioritySelect').value = document.getElementById('suggestedPriority').value;
    document.getElementById('categorySelect').value = document.getElementById('suggestedCategory').value;
    document.getElementById('dueDateInput').value = document.getElementById('suggestedDueDate').value;
    closeSuggestionsModal();
}

function closeSuggestionsModal() {
    const modal = document.getElementById('suggestionsModal');
    if (modal) {
        modal.style.setProperty('display', 'none', 'important');
    }
    // Reset form state
    const content = document.getElementById('suggestionsContent');
    const error = document.getElementById('suggestionsError');
    const loading = document.getElementById('suggestionsLoading');
    if (content) content.style.display = 'none';
    if (error) error.style.display = 'none';
    if (loading) loading.style.display = 'flex';
}

function toggleRecurringFields() {
    const checkbox = document.getElementById('isRecurringCheckbox');
    const container = document.getElementById('recurringFieldsContainer');
    if (checkbox.checked) {
        container.style.display = 'block';
    } else {
        container.style.display = 'none';
    }
}

function populateEditForm() {
    {% if ticket %}
    document.getElementById('titleInput').value = {{ ticket.title|tojson }};
    {% if ticket.description %}
    document.getElementById('descriptionInput').value = {{ ticket.description|tojson }};
    {% else %}
    document.getElementById('descriptionInput').value = '';
    {% endif %}
    document.getElementById('statusSelect').value = {{ ticket.status|tojson }};
    document.getElementById('prioritySelect').value = {{ ticket.priority|tojson }};
    document.getElementById('categorySelect').value = {{ ticket.category|tojson if ticket.category else 'other'|tojson }};
    {% if ticket.due_date %}
    document.getElementById('dueDateInput').value = {{ ticket.due_date.strftime('%Y-%m-%d')|tojson }};
    {% endif %}
    
    // Populate issue title
    {% if ticket.issue_title %}
    const issueSelect = document.getElementById('issueSelect');
    const issueInput = document.getElementById('issueTitleInput');
    const issueTitle = {{ ticket.issue_title|tojson }};
    
    // Try to set in dropdown first
    if (issueSelect) {
        issueSelect.value = issueTitle;
        // If not found in dropdown, switch to manual input
        if (issueSelect.value !== issueTitle) {
            issueInput.value = issueTitle;
            issueInput.style.display = 'block';
            issueSelect.style.display = 'none';
        }
    } else if (issueInput) {
        issueInput.value = issueTitle;
    }
    {% endif %}
    
    // Populate recurring fields
    {% if ticket.is_recurring %}
    document.getElementById('isRecurringCheckbox').checked = true;
    toggleRecurringFields();
    {% if ticket.frequency_value %}
    document.getElementById('frequencyValueInput').value = {{ ticket.frequency_value }};
    {% endif %}
    {% if ticket.frequency_unit %}
    document.getElementById('frequencyUnitSelect').value = {{ ticket.frequency_unit|tojson }};
    {% endif %}
    {% if ticket.reopen_days_before_due_date %}
    document.getElementById('reopenDaysInput').value = {{ ticket.reopen_days_before_due_date }};
    {% endif %}
    {% endif %}
    {% endif %}
}

function initializeTicketFormImages() {
    const container = document.getElementById('ticketFormImagesContainer');
    if (!container) return;
    
    if (ticketId) {
        // Edit mode - initialize with existing images
        ticketFormImageUploader = new ImageUploader(container, {
            uploadEndpoint: `/tickets/api/tickets/${ticketId}/images`,
            deleteEndpoint: `/tickets/api/tickets/${ticketId}/images`,
            listEndpoint: `/tickets/api/tickets/${ticketId}/images`,
            imageServeUrl: '/tickets/api/images',
            thumbnailUrl: '/tickets/api/images',
            maxFiles: 10,
            maxFileSize: 2 * 1024 * 1024
        });
    } else {
        // Create mode - use a custom upload handler that stores files for later
        container.innerHTML = '';
        container.className = 'ticket-images-container';
        
        const header = document.createElement('div');
        header.className = 'ticket-images-header';
        header.innerHTML = '<h4>Images</h4>';
        container.appendChild(header);
        
        const gallery = document.createElement('div');
        gallery.className = 'ticket-images-gallery';
        gallery.id = 'ticketFormImagesGallery';
        container.appendChild(gallery);
        
        const uploadArea = document.createElement('div');
        uploadArea.className = 'ticket-images-upload';
        
        const uploadInput = document.createElement('input');
        uploadInput.type = 'file';
        uploadInput.accept = 'image/*';
        uploadInput.multiple = true;
        uploadInput.style.display = 'none';
        uploadInput.addEventListener('change', (e) => handleFormImageSelect(e));
        
        const uploadLabel = document.createElement('label');
        uploadLabel.className = 'ticket-images-upload-label';
        uploadLabel.innerHTML = `
            <div class="upload-icon">ðŸ“·</div>
            <div class="upload-text">Click to upload or drag and drop</div>
            <div class="upload-hint">PNG, JPG, WebP, GIF, HEIC up to 2MB</div>
        `;
        uploadLabel.appendChild(uploadInput);
        
        uploadArea.appendChild(uploadLabel);
        container.appendChild(uploadArea);
        
        // Drag and drop
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('drag-over');
        });
        
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('drag-over');
        });
        
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('drag-over');
            const files = Array.from(e.dataTransfer.files);
            handleFormImageFiles(files);
        });
        
        uploadLabel.addEventListener('click', (e) => {
            if (e.target !== uploadInput) {
                e.preventDefault();
                uploadInput.click();
            }
        });
    }
}

function handleFormImageSelect(e) {
    const files = Array.from(e.target.files);
    handleFormImageFiles(files);
    e.target.value = '';
}

function handleFormImageFiles(files) {
    const validFiles = files.filter(file => {
        if (!file.type.startsWith('image/')) {
            alert(`File ${file.name} is not an image`);
            return false;
        }
        // Don't reject large files - backend will create thumbnail only
        return true;
    });
    
    if (validFiles.length === 0) return;
    
    if (pendingImages.length + validFiles.length > 10) {
        alert('Maximum 10 images allowed');
        return;
    }
    
    validFiles.forEach(file => {
        pendingImages.push(file);
        renderFormImagePreview(file);
    });
}

function renderFormImagePreview(file) {
    const gallery = document.getElementById('ticketFormImagesGallery');
    if (!gallery) return;
    
    const item = document.createElement('div');
    item.className = 'ticket-image-item image-preview';
    item.dataset.fileName = file.name;
    
    const img = document.createElement('img');
    img.src = URL.createObjectURL(file);
    img.className = 'ticket-image-thumb';
    
    const overlay = document.createElement('div');
    overlay.className = 'ticket-image-overlay';
    
    const deleteBtn = document.createElement('button');
    deleteBtn.className = 'ticket-image-delete';
    deleteBtn.innerHTML = 'Ã—';
    deleteBtn.onclick = () => {
        pendingImages = pendingImages.filter(f => f !== file);
        item.remove();
    };
    
    overlay.appendChild(deleteBtn);
    item.appendChild(img);
    item.appendChild(overlay);
    gallery.appendChild(item);
}

async function uploadPendingImages(ticketId) {
    if (pendingImages.length === 0) return;
    
    const uploadPromises = pendingImages.map(file => {
        const formData = new FormData();
        formData.append('image', file);
        return fetch(`/tickets/api/tickets/${ticketId}/images`, {
            method: 'POST',
            body: formData
        });
    });
    
    try {
        await Promise.all(uploadPromises);
    } catch (error) {
        console.error('Error uploading images:', error);
        // Don't block navigation if image upload fails
    }
}

function saveTicket(event) {
    event.preventDefault();
    
    // Get selected listing IDs from multi-select
    const selectedListingIds = listingMultiSelect ? listingMultiSelect.getSelectedListingIds() : [];
    const validListingIds = selectedListingIds.filter(id => id !== 0); // Exclude "General" (0)
    const firstListingId = validListingIds.length > 0 ? validListingIds[0] : null; // For backward compatibility
    
    const issueSelect = document.getElementById('issueSelect');
    const issueInput = document.getElementById('issueTitleInput');
    let issueTitle = issueInput.style.display !== 'none' ? issueInput.value : issueSelect.value;
    const title = document.getElementById('titleInput').value.trim();
        const description = document.getElementById('descriptionInput').value;
        const status = document.getElementById('statusSelect').value;
        const priority = document.getElementById('prioritySelect').value;
        const category = document.getElementById('categorySelect').value;
        const assignedId = document.getElementById('assignedSelect').value;
        const dueDate = document.getElementById('dueDateInput').value;
    
    // Title is always required
    if (!title) {
        alert('Please enter a ticket title');
        return;
    }
    
    // For general tickets (no property), use title as issue_title if not provided
    if (validListingIds.length === 0 && !issueTitle) {
        issueTitle = title;
    }
    
    // Issue title is required if listings are selected
    if (validListingIds.length > 0 && !issueTitle) {
        alert('Please select an issue or enter an issue title');
        return;
    }
    
    // Get selected tags (only non-inherited tags - inherited ones are added automatically)
    let tagIds = [];
    if (ticketTagInput) {
        const allSelectedTags = ticketTagInput.getTags() || [];
        // Only include non-inherited tags (inherited tags are added automatically by backend)
        // Filter to only include tags with tag_id (not just names)
        tagIds = allSelectedTags
            .filter(tag => !tag.is_inherited && tag.tag_id)
            .map(tag => tag.tag_id);
    }
    
    const data = {
        listing_id: firstListingId ? parseInt(firstListingId) : null,  // Keep for backward compatibility
        listing_ids: validListingIds.length > 0 ? validListingIds.map(id => parseInt(id)) : [],  // New: multiple listings
        issue_title: issueTitle,
        title: title,
        description: description,
        status: status,
        priority: priority,
        category: category,
        assigned_user_id: assignedId ? parseInt(assignedId) : null,
        due_date: dueDate || null,
        tag_ids: tagIds  // Include user-selected tags (for both create and update)
    };
    
    // Add recurring task fields
    const isRecurring = document.getElementById('isRecurringCheckbox').checked;
    if (isRecurring) {
        const frequencyValue = document.getElementById('frequencyValueInput').value;
        const frequencyUnit = document.getElementById('frequencyUnitSelect').value;
        const reopenDays = document.getElementById('reopenDaysInput').value;
        
        if (!frequencyValue || !frequencyUnit) {
            alert('Please enter frequency value and unit for recurring tasks');
            return;
        }
        
        data.is_recurring = true;
        data.frequency_value = parseInt(frequencyValue);
        data.frequency_unit = frequencyUnit;
        data.reopen_days_before_due_date = reopenDays ? parseInt(reopenDays) : 10;
        
        // Set initial_due_date to due_date if provided
        if (dueDate) {
            data.initial_due_date = dueDate;
        }
        
        {% if ticket %}
        // In edit mode, allow updating is_recurring_active
        const isRecurringActive = document.getElementById('isRecurringActiveCheckbox');
        if (isRecurringActive) {
            data.is_recurring_active = isRecurringActive.checked;
        }
        {% endif %}
    } else {
        data.is_recurring = false;
    }
    
    const url = ticketId ? `/tickets/api/tickets/${ticketId}` : '/tickets/api/tickets';
    const method = ticketId ? 'PUT' : 'POST';
    
    fetch(url, {
        method: method,
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(async (result) => {
        if (result.error) {
            alert('Error: ' + result.error);
        } else {
            const newTicketId = result.ticket_id || ticketId;
            
            // Upload pending images if creating a new ticket
            if (!ticketId && pendingImages.length > 0) {
                await uploadPendingImages(newTicketId);
            }
            
            window.location.href = `/tickets/${newTicketId}/page`;
        }
    })
    .catch(error => {
        console.error('Error saving ticket:', error);
        alert('Error saving ticket');
    });
}

// Close modal when clicking outside
document.addEventListener('click', function(event) {
    const modal = document.getElementById('suggestionsModal');
    if (modal && event.target === modal) {
        closeSuggestionsModal();
    }
});

async function initializeTicketTags() {
    const container = document.getElementById('ticketTagsInput');
    if (!container) return;
    
    // Get existing tags if editing
    let existingTags = [];
    {% if ticket %}
    // In edit mode, load existing tags
    try {
        const response = await fetch(`/tickets/api/tickets/${ticketId}/tags`);
        if (response.ok) {
            const data = await response.json();
            // API returns either an array directly or wrapped in {tags: [...]}
            if (Array.isArray(data)) {
                existingTags = data;
            } else if (data.tags && Array.isArray(data.tags)) {
                existingTags = data.tags;
            }
            console.log('Loaded existing tags:', existingTags);
        } else {
            console.error('Failed to load ticket tags:', response.status, response.statusText);
        }
    } catch (error) {
        console.error('Error loading ticket tags:', error);
    }
    {% endif %}
    
    // Initialize TagInput with existing tags (or empty array for create mode)
    ticketTagInput = new TagInput(container, {
        endpoint: '/api/tags/autocomplete',
        placeholder: 'Type to add tags...',
        allowCreate: true,
        existingTags: existingTags,
        onTagsChange: (tags) => {
            // Tags changed - no action needed, will be sent on save
        }
    });
    
    // If editing and we have a listing, also load inherited tags
    {% if ticket %}
    {% if ticket.listing_id %}
    // Load inherited tags from listing (after a short delay to ensure TagInput is ready)
    setTimeout(() => {
        loadPropertyTags();
    }, 100);
    {% endif %}
    {% endif %}
}

function loadPropertyTags() {
    if (!ticketTagInput || !listingMultiSelect) {
        return;
    }
    
    // Get selected listing IDs from multi-select
    const selectedListingIds = listingMultiSelect.getSelectedListingIds();
    const validListingIds = selectedListingIds.filter(id => id !== 0); // Exclude "General"
    
    // Get current tags
    const currentTags = ticketTagInput.getTags() || [];
    
    if (validListingIds.length === 0) {
        // No listings selected - remove all inherited tags
        const nonInheritedTags = currentTags.filter(tag => !tag.is_inherited);
        ticketTagInput.setTags(nonInheritedTags);
        return;
    }
    
    // Fetch tags from all selected listings
    const tagPromises = validListingIds.map(listingId => 
        fetch(`/api/listings/${listingId}/tags`)
            .then(response => response.json())
            .catch(error => {
                console.error(`Error loading tags for listing ${listingId}:`, error);
                return [];
            })
    );
    
    Promise.all(tagPromises)
        .then(tagArrays => {
            // Combine all tags from all selected listings
            const allInheritedTags = [];
            const seenTagIds = new Set();
            
            tagArrays.forEach(tags => {
                tags.forEach(tag => {
                    if (!seenTagIds.has(tag.tag_id)) {
                        seenTagIds.add(tag.tag_id);
                        allInheritedTags.push({
                            ...tag,
                            is_inherited: true
                        });
                    }
                });
            });
            
            // Remove old inherited tags and add new ones
            const nonInheritedTags = currentTags.filter(tag => !tag.is_inherited);
            const currentTagIds = new Set(nonInheritedTags.map(t => t.tag_id));
            
            // Filter out tags that user already added manually
            const newInheritedTags = allInheritedTags.filter(tag => !currentTagIds.has(tag.tag_id));
            
            // Combine: non-inherited tags first, then inherited tags
            const allTags = [...nonInheritedTags, ...newInheritedTags];
            ticketTagInput.setTags(allTags);
        })
        .catch(error => {
            console.error('Error loading property tags:', error);
        });
}
</script>
</div>
{% endblock %}
